---
title: "P.tuahiniensis GFF reformatting"
author: "Sam White"
date: "2025-01-14"
output: 
  bookdown::html_document2:
    theme: cosmo
    toc: true
    toc_float: true
    number_sections: true
    code_folding: show
    code_download: true
  github_document:
    toc: true
    number_sections: true
  html_document:
    theme: cosmo
    toc: true
    toc_float: true
    number_sections: true
    code_folding: show
    code_download: true
---

# Background

This notebook reformats the original _P.tuahiniensis_ GFF ([Pocillopora_meandrina_HIv1.genes.gff3](../data/Pocillopora_meandrina_HIv1.genes.gff3)),

Finally, despite the naming convention, there aren't any actual annotations in that GFF, beyond the feature designations (i.e. no gene ontology, no SwissProt IDs, gene names, etc.). This notebook does _not_ address those shortcomings.

::: {.callout-note}
Unlike other scripts, this will output to [`F-Ptua/data`](../data), instead of an output directory in `../output`.
:::

## Software requirements

Requires [genometools](https://github.com/genometools/genometools) (GitHub repo) to be installed and in the system `$PATH`.

## Inputs

- [`Pocillopora_meandrina_HIv1.genes.gff3`](../data/Pocillopora_meandrina_HIv1.genes.gff3)

## Outputs

- [`Pocillopora_meandrina_HIv1.genes-validated.gff3`](../data/Pocillopora_meandrina_HIv1.genes-validated.gff3)

```{r setup, include=FALSE}
library(knitr)
knitr::opts_chunk$set(
  echo = TRUE,         # Display code chunks
  eval = FALSE,        # Evaluate code chunks
  warning = FALSE,     # Hide warnings
  message = FALSE,     # Hide messages
  comment = ""         # Prevents appending '##' to beginning of lines in code output
)
```

# Load libraries
```{r load-libraries}
library(tidyverse)
```

# Create a Bash variables file

This allows usage of Bash variables across R Markdown chunks.

```{r save-bash-variables-to-rvars-file, engine='bash', eval=TRUE}
{
echo "#### Assign Variables ####"
echo ""

echo "# Data directories"
echo 'export repo_dir=~/gitrepos/urol-e5/timeseries_molecular'
echo 'export data_dir=${repo_dir}/F-Ptua/data'
echo ""

echo "# Input files"
echo 'export original_gff="Pocillopora_meandrina_HIv1.genes.gff3"'
echo 'export intermediate_gff="intermediate.gff3"'
echo 'export validated_gff="Pocillopora_meandrina_HIv1.genes-validated.gff3"'
echo ""

echo "# Print formatting"
echo 'export line="--------------------------------------------------------"'
echo ""
} > .bashvars

cat .bashvars
```

# Read GFF3 file
```{r load-input-gff, eval=TRUE}
gff <- read_delim("../data/Pocillopora_meandrina_HIv1.genes.gff3", 
                  delim="\t", 
                  col_names=c("seqid", "source", "type", "start", "end", 
                            "score", "strand", "phase", "attributes"),
                  show_col_types = FALSE)
str(gff)
```

# Get unique types
```{r unqique-features, eval=TRUE}
# Get and print unique types, one per line
cat("Unique feature types in original GFF3:\n")
gff %>%
  distinct(type) %>%
  pull(type) %>%
  walk(~cat("-", .x, "\n"))
```

# Create gene entries from transcript entries
```{r create-gene-entries, eval=TRUE}
gene_entries <- gff %>%
  filter(type == "transcript") %>%
  mutate(
    type = "gene",
    # Replace prefix but keep TS/RNAseq
    full_id = str_replace(attributes, 
                         "ID=Pocillopora_meandrina_HIv1___", 
                         "ID=gene-"),
    # Clean up gene ID by removing suffixes
    attributes = str_remove_all(full_id, "[._]t[a-z0-9]*(?=;|$)")
  ) %>%
  select(-full_id)

str(gene_entries)
```

# Create mRNA, Feature IDs, and Parent Attributes
```{r replace-transcript-with-mRNA, eval=TRUE}
modified_gff <- gff %>%
  mutate(
    # Convert transcript to mRNA
    type = if_else(type == "transcript", "mRNA", type),
    type_lower = tolower(type),
    
    # Process ID and Parent attributes separately
    processed_id = str_replace(
      attributes,
      "ID=Pocillopora_meandrina_HIv1___",
      paste0("ID=", type_lower, "-")
    ),
    
    # Build final attributes string
    attributes = case_when(
      # For mRNA features
      type == "mRNA" ~ {
        base_id <- str_extract(processed_id, "(?:TS|RNAseq)\\.[^;]+")
        parent_id <- str_remove_all(base_id, "[._]t[a-z0-9]*$")
        paste0(processed_id, ";Parent=gene-", parent_id)
      },
      
      # For sub-features (CDS, exon)
      str_detect(processed_id, "Parent=") ~ {
        # Extract original ID part
        id_part <- str_extract(processed_id, "(?:TS|RNAseq)\\.[^;]+")
        # Clean up Parent reference
        parent_part <- str_extract(attributes, "Parent=.*$") %>%
          str_replace("Parent=Pocillopora_meandrina_HIv1___", "Parent=mrna-")
        paste0("ID=", type_lower, "-", id_part, ";", parent_part)
      },
      
      # For any other features
      TRUE ~ processed_id
    )
  ) %>%
  select(-type_lower, -processed_id)

str(modified_gff)
```

# Number exons within mRNA groups
```{r number-exons, eval=TRUE}
exons_gff <- modified_gff %>%
  # Group by mRNA boundaries
  group_by(seqid, 
           mRNA_group = cumsum(type == "mRNA")) %>%
  # Add exon numbers within groups
  mutate(
    # Only count when type is exon
    exon_num = if_else(type == "exon",
                       cumsum(type == "exon"),
                       NA_integer_),
    # Modify attributes to append exon number
    attributes = if_else(
      type == "exon",
      str_replace(attributes, 
                 "(ID=exon-[^;]+)",
                 paste0("\\1-", exon_num)),
      attributes
    )
  ) %>%
  ungroup() %>%
  select(-mRNA_group, -exon_num) %>%
  arrange(seqid, start)

str(exons_gff)
```

# Combine and sort
```{r combine-and-sort, eval=TRUE}
intermediate_gff <- bind_rows(gene_entries, exons_gff) %>%
  arrange(seqid, start)

str(intermediate_gff)
```

# Unique features
```{r unqique-features-updated-gff, eval=TRUE}
# Get and print unique types, one per line
cat("Unique feature types in final GFF3:\n")
intermediate_gff %>%
  distinct(type) %>%
  pull(type) %>%
  walk(~cat("-", .x, "\n"))
```

# Write output
```{r write-reformatted-gff, eval=TRUE}
write_delim(intermediate_gff, 
            "../data/intermediate.gff3", 
            delim="\t",
            col_names=FALSE)
```


# Validate GFF

Validate GFF using genometools `gff3`.

- `-tidy`: Attempts to clean/fix any potential issues.

- `-checkids`: Checks IDs.

- `-retainids`: Retains IDs from input GFF instead of assigning new ones.

```{r validate-gff, engine='bash', eval=FALSE}
source .bashvars

gt gff3 \
-tidy \
-checkids \
-retainids \
"${data_dir}"/"${intermediate_gff}" \
> "${data_dir}"/"${validated_gff}" \
2> "${data_dir}"/gt_gff3_validation_errors.log
```

## Check for error(s) in validation

Process would stop if error occurred, so only need to check end of file.

```{r validate-gff-error-check, engine='bash', eval=TRUE}
source .bashvars

tail "${data_dir}"/gt_gff3_validation_errors.log
```

## Inspect Validated GFF
```{r validated-gff, engine='bash', eval=TRUE}
source .bashvars

head "${data_dir}"/"${validated_gff}"
```