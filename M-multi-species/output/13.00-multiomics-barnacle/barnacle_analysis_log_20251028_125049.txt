============================================================
BARNACLE ANALYSIS LOG
Started: 2025-10-28 12:50:50
Log file: ../output/13.00-multiomics-barnacle/barnacle_analysis_log_20251028_125049.txt
============================================================

Working in output directory: ../output/13.00-multiomics-barnacle
Loaded normalized data:
Apul: (10223, 41)
Peve: (10223, 37)
Ptua: (10223, 37)

Common genes across all species: 10223

Filtered to common genes:
Apul: (10223, 40)
Peve: (10223, 36)
Ptua: (10223, 36)
Parsing sample information for each species...
apul:
  Samples: 10 (['ACR.139', 'ACR.145', 'ACR.150']...)
  Timepoints: [1, 2, 3, 4]
peve:
  Samples: 9 (['POR.216', 'POR.245', 'POR.260']...)
  Timepoints: [1, 2, 3, 4]
ptua:
  Samples: 9 (['POC.219', 'POC.222', 'POC.255']...)
  Timepoints: [1, 2, 3, 4]

Timepoints found across all species: [1, 2, 3, 4]
Maximum samples in any species: 10

Detailed sample structure:
apul: 10 samples × 4 timepoints
peve: 9 samples × 4 timepoints
ptua: 9 samples × 4 timepoints
Creating 3D tensor by combining species and samples...
Note: R-level filtering has already removed samples without all 4 timepoints

Processing apul:
  Added ACR.139 with 4 timepoints: [1, 2, 3, 4]
  Added ACR.145 with 4 timepoints: [1, 2, 3, 4]
  Added ACR.150 with 4 timepoints: [1, 2, 3, 4]
  Added ACR.173 with 4 timepoints: [1, 2, 3, 4]
  Added ACR.186 with 4 timepoints: [1, 2, 3, 4]
  Added ACR.225 with 4 timepoints: [1, 2, 3, 4]
  Added ACR.229 with 4 timepoints: [1, 2, 3, 4]
  Added ACR.237 with 4 timepoints: [1, 2, 3, 4]
  Added ACR.244 with 4 timepoints: [1, 2, 3, 4]
  Added ACR.265 with 4 timepoints: [1, 2, 3, 4]

Processing peve:
  Added POR.216 with 4 timepoints: [1, 2, 3, 4]
  Added POR.245 with 4 timepoints: [1, 2, 3, 4]
  Added POR.260 with 4 timepoints: [1, 2, 3, 4]
  Added POR.262 with 4 timepoints: [1, 2, 3, 4]
  Added POR.69 with 4 timepoints: [1, 2, 3, 4]
  Added POR.72 with 4 timepoints: [1, 2, 3, 4]
  Added POR.73 with 4 timepoints: [1, 2, 3, 4]
  Added POR.74 with 4 timepoints: [1, 2, 3, 4]
  Added POR.83 with 4 timepoints: [1, 2, 3, 4]

Processing ptua:
  Added POC.219 with 4 timepoints: [1, 2, 3, 4]
  Added POC.222 with 4 timepoints: [1, 2, 3, 4]
  Added POC.255 with 4 timepoints: [1, 2, 3, 4]
  Added POC.259 with 4 timepoints: [1, 2, 3, 4]
  Added POC.40 with 4 timepoints: [1, 2, 3, 4]
  Added POC.42 with 4 timepoints: [1, 2, 3, 4]
  Added POC.52 with 4 timepoints: [1, 2, 3, 4]
  Added POC.53 with 4 timepoints: [1, 2, 3, 4]
  Added POC.57 with 4 timepoints: [1, 2, 3, 4]

Creating 3D tensor with shape: (10223, 28, 4)
Combined samples from all species: 28

=== TENSOR STATISTICS ===
Tensor shape: (10223, 28, 4)
Total elements: 1144976
Finite values: 1144976
Missing/NaN values: 0
Missing percentage: 0.00%
Filled 112 sample-timepoint combinations
Missing 0 sample-timepoint combinations
Non-zero finite values: 1128956
Zero finite values: 16020
Sparsity among finite values: 1.40%

Sample mapping:
   combined_index  sample_label species sample_id
0               0  apul_ACR.139    apul   ACR.139
1               1  apul_ACR.145    apul   ACR.145
2               2  apul_ACR.150    apul   ACR.150
3               3  apul_ACR.173    apul   ACR.173
4               4  apul_ACR.186    apul   ACR.186
5               5  apul_ACR.225    apul   ACR.225
6               6  apul_ACR.229    apul   ACR.229
7               7  apul_ACR.237    apul   ACR.237
8               8  apul_ACR.244    apul   ACR.244
9               9  apul_ACR.265    apul   ACR.265

============================================================
FACTOR MATCH SCORE (FMS) EVALUATION
============================================================
This analysis evaluates decomposition quality using the Factor Match Score
from the tensorly-viz (tlviz) library, which measures how well the
decomposed factors match the original tensor structure.
============================================================
Found 12 successful ranks to evaluate: [5, 8, 10, 12, 15, 20, 25, 35, 45, 55, 65, 75]

--- Evaluating FMS for Rank 5 ---
  Loaded factor matrices - Genes: (10223, 5), Samples: (28, 5), Time: (4, 5)
  WARNING: tlviz not available. Installing required dependencies...
  Error calculating FMS for rank 5: cannot import name '_lazywhere' from 'scipy._lib._util' (/home/sam/programs/mambaforge/envs/barnacle_py311_env/lib/python3.11/site-packages/scipy/_lib/_util.py)
  TLViz FMS: Failed (cannot import name '_lazywhere' from 'scipy._lib._util' (/home/sam/programs/mambaforge/envs/barnacle_py311_env/lib/python3.11/site-packages/scipy/_lib/_util.py))
  Reconstruction FMS: 0.7601 (correlation: 0.5202)
  Valid elements used: 1,144,976
  Saved FMS results to: factor_match_score.json

--- Evaluating FMS for Rank 8 ---
  Loaded factor matrices - Genes: (10223, 8), Samples: (28, 8), Time: (4, 8)
  WARNING: tlviz not available. Installing required dependencies...
  Error calculating FMS for rank 8: cannot import name '_lazywhere' from 'scipy._lib._util' (/home/sam/programs/mambaforge/envs/barnacle_py311_env/lib/python3.11/site-packages/scipy/_lib/_util.py)
  TLViz FMS: Failed (cannot import name '_lazywhere' from 'scipy._lib._util' (/home/sam/programs/mambaforge/envs/barnacle_py311_env/lib/python3.11/site-packages/scipy/_lib/_util.py))
  Reconstruction FMS: 0.8003 (correlation: 0.6005)
  Valid elements used: 1,144,976
  Saved FMS results to: factor_match_score.json

--- Evaluating FMS for Rank 10 ---
  Loaded factor matrices - Genes: (10223, 10), Samples: (28, 10), Time: (4, 10)
  WARNING: tlviz not available. Installing required dependencies...
  Error calculating FMS for rank 10: cannot import name '_lazywhere' from 'scipy._lib._util' (/home/sam/programs/mambaforge/envs/barnacle_py311_env/lib/python3.11/site-packages/scipy/_lib/_util.py)
  TLViz FMS: Failed (cannot import name '_lazywhere' from 'scipy._lib._util' (/home/sam/programs/mambaforge/envs/barnacle_py311_env/lib/python3.11/site-packages/scipy/_lib/_util.py))
  Reconstruction FMS: 0.8225 (correlation: 0.6451)
  Valid elements used: 1,144,976
  Saved FMS results to: factor_match_score.json

--- Evaluating FMS for Rank 12 ---
  Loaded factor matrices - Genes: (10223, 12), Samples: (28, 12), Time: (4, 12)
  WARNING: tlviz not available. Installing required dependencies...
  Error calculating FMS for rank 12: cannot import name '_lazywhere' from 'scipy._lib._util' (/home/sam/programs/mambaforge/envs/barnacle_py311_env/lib/python3.11/site-packages/scipy/_lib/_util.py)
  TLViz FMS: Failed (cannot import name '_lazywhere' from 'scipy._lib._util' (/home/sam/programs/mambaforge/envs/barnacle_py311_env/lib/python3.11/site-packages/scipy/_lib/_util.py))
  Reconstruction FMS: 0.8398 (correlation: 0.6797)
  Valid elements used: 1,144,976
  Saved FMS results to: factor_match_score.json

--- Evaluating FMS for Rank 15 ---
  Loaded factor matrices - Genes: (10223, 15), Samples: (28, 15), Time: (4, 15)
  WARNING: tlviz not available. Installing required dependencies...
  Error calculating FMS for rank 15: cannot import name '_lazywhere' from 'scipy._lib._util' (/home/sam/programs/mambaforge/envs/barnacle_py311_env/lib/python3.11/site-packages/scipy/_lib/_util.py)
  TLViz FMS: Failed (cannot import name '_lazywhere' from 'scipy._lib._util' (/home/sam/programs/mambaforge/envs/barnacle_py311_env/lib/python3.11/site-packages/scipy/_lib/_util.py))
  Reconstruction FMS: 0.8610 (correlation: 0.7219)
  Valid elements used: 1,144,976
  Saved FMS results to: factor_match_score.json

--- Evaluating FMS for Rank 20 ---
  Loaded factor matrices - Genes: (10223, 20), Samples: (28, 20), Time: (4, 20)
  WARNING: tlviz not available. Installing required dependencies...
  Error calculating FMS for rank 20: cannot import name '_lazywhere' from 'scipy._lib._util' (/home/sam/programs/mambaforge/envs/barnacle_py311_env/lib/python3.11/site-packages/scipy/_lib/_util.py)
  TLViz FMS: Failed (cannot import name '_lazywhere' from 'scipy._lib._util' (/home/sam/programs/mambaforge/envs/barnacle_py311_env/lib/python3.11/site-packages/scipy/_lib/_util.py))
  Reconstruction FMS: 0.8863 (correlation: 0.7726)
  Valid elements used: 1,144,976
  Saved FMS results to: factor_match_score.json

--- Evaluating FMS for Rank 25 ---
  Loaded factor matrices - Genes: (10223, 25), Samples: (28, 25), Time: (4, 25)
  WARNING: tlviz not available. Installing required dependencies...
  Error calculating FMS for rank 25: cannot import name '_lazywhere' from 'scipy._lib._util' (/home/sam/programs/mambaforge/envs/barnacle_py311_env/lib/python3.11/site-packages/scipy/_lib/_util.py)
  TLViz FMS: Failed (cannot import name '_lazywhere' from 'scipy._lib._util' (/home/sam/programs/mambaforge/envs/barnacle_py311_env/lib/python3.11/site-packages/scipy/_lib/_util.py))
  Reconstruction FMS: 0.9059 (correlation: 0.8118)
  Valid elements used: 1,144,976
  Saved FMS results to: factor_match_score.json

--- Evaluating FMS for Rank 35 ---
  Loaded factor matrices - Genes: (10223, 35), Samples: (28, 35), Time: (4, 35)
  WARNING: tlviz not available. Installing required dependencies...
  Error calculating FMS for rank 35: cannot import name '_lazywhere' from 'scipy._lib._util' (/home/sam/programs/mambaforge/envs/barnacle_py311_env/lib/python3.11/site-packages/scipy/_lib/_util.py)
  TLViz FMS: Failed (cannot import name '_lazywhere' from 'scipy._lib._util' (/home/sam/programs/mambaforge/envs/barnacle_py311_env/lib/python3.11/site-packages/scipy/_lib/_util.py))
  Reconstruction FMS: 0.9341 (correlation: 0.8681)
  Valid elements used: 1,144,976
  Saved FMS results to: factor_match_score.json

--- Evaluating FMS for Rank 45 ---
  Loaded factor matrices - Genes: (10223, 45), Samples: (28, 45), Time: (4, 45)
  WARNING: tlviz not available. Installing required dependencies...
  Error calculating FMS for rank 45: cannot import name '_lazywhere' from 'scipy._lib._util' (/home/sam/programs/mambaforge/envs/barnacle_py311_env/lib/python3.11/site-packages/scipy/_lib/_util.py)
  TLViz FMS: Failed (cannot import name '_lazywhere' from 'scipy._lib._util' (/home/sam/programs/mambaforge/envs/barnacle_py311_env/lib/python3.11/site-packages/scipy/_lib/_util.py))
  Reconstruction FMS: 0.9533 (correlation: 0.9066)
  Valid elements used: 1,144,976
  Saved FMS results to: factor_match_score.json

--- Evaluating FMS for Rank 55 ---
  Loaded factor matrices - Genes: (10223, 55), Samples: (28, 55), Time: (4, 55)
  WARNING: tlviz not available. Installing required dependencies...
  Error calculating FMS for rank 55: cannot import name '_lazywhere' from 'scipy._lib._util' (/home/sam/programs/mambaforge/envs/barnacle_py311_env/lib/python3.11/site-packages/scipy/_lib/_util.py)
  TLViz FMS: Failed (cannot import name '_lazywhere' from 'scipy._lib._util' (/home/sam/programs/mambaforge/envs/barnacle_py311_env/lib/python3.11/site-packages/scipy/_lib/_util.py))
  Reconstruction FMS: 0.9663 (correlation: 0.9326)
  Valid elements used: 1,144,976
  Saved FMS results to: factor_match_score.json

--- Evaluating FMS for Rank 65 ---
  Loaded factor matrices - Genes: (10223, 65), Samples: (28, 65), Time: (4, 65)
  WARNING: tlviz not available. Installing required dependencies...
  Error calculating FMS for rank 65: cannot import name '_lazywhere' from 'scipy._lib._util' (/home/sam/programs/mambaforge/envs/barnacle_py311_env/lib/python3.11/site-packages/scipy/_lib/_util.py)
  TLViz FMS: Failed (cannot import name '_lazywhere' from 'scipy._lib._util' (/home/sam/programs/mambaforge/envs/barnacle_py311_env/lib/python3.11/site-packages/scipy/_lib/_util.py))
  Reconstruction FMS: 0.9761 (correlation: 0.9523)
  Valid elements used: 1,144,976
  Saved FMS results to: factor_match_score.json

--- Evaluating FMS for Rank 75 ---
  Loaded factor matrices - Genes: (10223, 75), Samples: (28, 75), Time: (4, 75)
  WARNING: tlviz not available. Installing required dependencies...
  Error calculating FMS for rank 75: cannot import name '_lazywhere' from 'scipy._lib._util' (/home/sam/programs/mambaforge/envs/barnacle_py311_env/lib/python3.11/site-packages/scipy/_lib/_util.py)
  TLViz FMS: Failed (cannot import name '_lazywhere' from 'scipy._lib._util' (/home/sam/programs/mambaforge/envs/barnacle_py311_env/lib/python3.11/site-packages/scipy/_lib/_util.py))
  Reconstruction FMS: 0.9838 (correlation: 0.9676)
  Valid elements used: 1,144,976
  Saved FMS results to: factor_match_score.json

============================================================
FMS RESULTS SUMMARY
============================================================
Saved FMS comparison table to: ../output/13.00-multiomics-barnacle/rank_comparison/factor_match_scores.csv

Factor Match Score Results:
 rank  fms_tlviz  fms_reconstruction  reconstruction_correlation
    5        NaN              0.7601                      0.5202
    8        NaN              0.8003                      0.6005
   10        NaN              0.8225                      0.6451
   12        NaN              0.8398                      0.6797
   15        NaN              0.8610                      0.7219
   20        NaN              0.8863                      0.7726
   25        NaN              0.9059                      0.8118
   35        NaN              0.9341                      0.8681
   45        NaN              0.9533                      0.9066
   55        NaN              0.9663                      0.9326
   65        NaN              0.9761                      0.9523
   75        NaN              0.9838                      0.9676
[<matplotlib.lines.Line2D object at 0x78e68f660390>]
Text(0.5, 0, 'Rank (Number of Components)')
Text(0, 0.5, 'Factor Match Score')
Text(0.5, 1.0, 'Factor Match Score vs Rank\n(Higher = Better Factor Recovery)')
<matplotlib.legend.Legend object at 0x78e60e1fbfd0>
(0.0, 1.05)
[<matplotlib.lines.Line2D object at 0x78e68f6edb10>]
<matplotlib.lines.Line2D object at 0x78e605ef5510>
<matplotlib.lines.Line2D object at 0x78e68f6ef790>
Text(0.5, 0, 'Rank (Number of Components)')
Text(0, 0.5, 'Reconstruction Correlation')
Text(0.5, 1.0, 'Tensor Reconstruction Quality vs Rank\n(Correlation between original and reconstructed)')
<matplotlib.legend.Legend object at 0x78e605c7e190>
(-1.05, 1.05)
Saved FMS plot to: ../output/13.00-multiomics-barnacle/rank_comparison/factor_match_scores_plot.png

============================================================
FMS-BASED RANK RECOMMENDATION
============================================================
Best Reconstruction FMS: Rank 75 (score: 0.9838)
Best Reconstruction Correlation: Rank 75 (score: 0.9676)

High-scoring ranks (top 20%): [55, 65, 75]
Threshold: 0.9637

FMS Interpretation:
• Factor Match Score measures how well the decomposition
  captures the underlying tensor structure
• Reconstruction correlation shows tensor reconstruction quality
• Higher scores indicate better factor recovery and model fit
• Consider ranks with consistently high FMS across methods

============================================================
FACTOR MATCH SCORE EVALUATION COMPLETE
============================================================

============================================================
FACTOR MATCH SCORE (FMS) EVALUATION
============================================================
This analysis evaluates decomposition quality using the Factor Match Score
from the tensorly-viz (tlviz) library, which measures how well the
decomposed factors match the original tensor structure.
============================================================
Found 12 successful ranks to evaluate: [5, 8, 10, 12, 15, 20, 25, 35, 45, 55, 65, 75]

--- Evaluating FMS for Rank 5 ---
  Loaded factor matrices - Genes: (10223, 5), Samples: (28, 5), Time: (4, 5)
  WARNING: tlviz not available for rank 5: cannot import name '_lazywhere' from 'scipy._lib._util' (/home/sam/programs/mambaforge/envs/barnacle_py311_env/lib/python3.11/site-packages/scipy/_lib/_util.py)
  Attempting to install tensorly-viz...
  Failed to install/import tlviz: cannot import name '_lazywhere' from 'scipy._lib._util' (/home/sam/programs/mambaforge/envs/barnacle_py311_env/lib/python3.11/site-packages/scipy/_lib/_util.py)
  TLViz FMS: Failed (Installation failed: cannot import name '_lazywhere' from 'scipy._lib._util' (/home/sam/programs/mambaforge/envs/barnacle_py311_env/lib/python3.11/site-packages/scipy/_lib/_util.py))
  Reconstruction FMS: 0.7601 (correlation: 0.5202)
  Valid elements used: 1,144,976
  Saved FMS results to: factor_match_score.json

--- Evaluating FMS for Rank 8 ---
  Loaded factor matrices - Genes: (10223, 8), Samples: (28, 8), Time: (4, 8)
  WARNING: tlviz not available for rank 8: cannot import name '_lazywhere' from 'scipy._lib._util' (/home/sam/programs/mambaforge/envs/barnacle_py311_env/lib/python3.11/site-packages/scipy/_lib/_util.py)
  Attempting to install tensorly-viz...
  Failed to install/import tlviz: cannot import name '_lazywhere' from 'scipy._lib._util' (/home/sam/programs/mambaforge/envs/barnacle_py311_env/lib/python3.11/site-packages/scipy/_lib/_util.py)
  TLViz FMS: Failed (Installation failed: cannot import name '_lazywhere' from 'scipy._lib._util' (/home/sam/programs/mambaforge/envs/barnacle_py311_env/lib/python3.11/site-packages/scipy/_lib/_util.py))
  Reconstruction FMS: 0.8003 (correlation: 0.6005)
  Valid elements used: 1,144,976
  Saved FMS results to: factor_match_score.json

--- Evaluating FMS for Rank 10 ---
  Loaded factor matrices - Genes: (10223, 10), Samples: (28, 10), Time: (4, 10)
  WARNING: tlviz not available for rank 10: cannot import name '_lazywhere' from 'scipy._lib._util' (/home/sam/programs/mambaforge/envs/barnacle_py311_env/lib/python3.11/site-packages/scipy/_lib/_util.py)
  Attempting to install tensorly-viz...
  Failed to install/import tlviz: cannot import name '_lazywhere' from 'scipy._lib._util' (/home/sam/programs/mambaforge/envs/barnacle_py311_env/lib/python3.11/site-packages/scipy/_lib/_util.py)
  TLViz FMS: Failed (Installation failed: cannot import name '_lazywhere' from 'scipy._lib._util' (/home/sam/programs/mambaforge/envs/barnacle_py311_env/lib/python3.11/site-packages/scipy/_lib/_util.py))
  Reconstruction FMS: 0.8225 (correlation: 0.6451)
  Valid elements used: 1,144,976
  Saved FMS results to: factor_match_score.json

--- Evaluating FMS for Rank 12 ---
  Loaded factor matrices - Genes: (10223, 12), Samples: (28, 12), Time: (4, 12)
  WARNING: tlviz not available for rank 12: cannot import name '_lazywhere' from 'scipy._lib._util' (/home/sam/programs/mambaforge/envs/barnacle_py311_env/lib/python3.11/site-packages/scipy/_lib/_util.py)
  Attempting to install tensorly-viz...
  Failed to install/import tlviz: cannot import name '_lazywhere' from 'scipy._lib._util' (/home/sam/programs/mambaforge/envs/barnacle_py311_env/lib/python3.11/site-packages/scipy/_lib/_util.py)
  TLViz FMS: Failed (Installation failed: cannot import name '_lazywhere' from 'scipy._lib._util' (/home/sam/programs/mambaforge/envs/barnacle_py311_env/lib/python3.11/site-packages/scipy/_lib/_util.py))
  Reconstruction FMS: 0.8398 (correlation: 0.6797)
  Valid elements used: 1,144,976
  Saved FMS results to: factor_match_score.json

--- Evaluating FMS for Rank 15 ---
  Loaded factor matrices - Genes: (10223, 15), Samples: (28, 15), Time: (4, 15)
  WARNING: tlviz not available for rank 15: cannot import name '_lazywhere' from 'scipy._lib._util' (/home/sam/programs/mambaforge/envs/barnacle_py311_env/lib/python3.11/site-packages/scipy/_lib/_util.py)
  Attempting to install tensorly-viz...
  Failed to install/import tlviz: cannot import name '_lazywhere' from 'scipy._lib._util' (/home/sam/programs/mambaforge/envs/barnacle_py311_env/lib/python3.11/site-packages/scipy/_lib/_util.py)
  TLViz FMS: Failed (Installation failed: cannot import name '_lazywhere' from 'scipy._lib._util' (/home/sam/programs/mambaforge/envs/barnacle_py311_env/lib/python3.11/site-packages/scipy/_lib/_util.py))
  Reconstruction FMS: 0.8610 (correlation: 0.7219)
  Valid elements used: 1,144,976
  Saved FMS results to: factor_match_score.json

--- Evaluating FMS for Rank 20 ---
  Loaded factor matrices - Genes: (10223, 20), Samples: (28, 20), Time: (4, 20)
  WARNING: tlviz not available for rank 20: cannot import name '_lazywhere' from 'scipy._lib._util' (/home/sam/programs/mambaforge/envs/barnacle_py311_env/lib/python3.11/site-packages/scipy/_lib/_util.py)
  Attempting to install tensorly-viz...
  Failed to install/import tlviz: cannot import name '_lazywhere' from 'scipy._lib._util' (/home/sam/programs/mambaforge/envs/barnacle_py311_env/lib/python3.11/site-packages/scipy/_lib/_util.py)
  TLViz FMS: Failed (Installation failed: cannot import name '_lazywhere' from 'scipy._lib._util' (/home/sam/programs/mambaforge/envs/barnacle_py311_env/lib/python3.11/site-packages/scipy/_lib/_util.py))
  Reconstruction FMS: 0.8863 (correlation: 0.7726)
  Valid elements used: 1,144,976
  Saved FMS results to: factor_match_score.json

--- Evaluating FMS for Rank 25 ---
  Loaded factor matrices - Genes: (10223, 25), Samples: (28, 25), Time: (4, 25)
  WARNING: tlviz not available for rank 25: cannot import name '_lazywhere' from 'scipy._lib._util' (/home/sam/programs/mambaforge/envs/barnacle_py311_env/lib/python3.11/site-packages/scipy/_lib/_util.py)
  Attempting to install tensorly-viz...
  Failed to install/import tlviz: cannot import name '_lazywhere' from 'scipy._lib._util' (/home/sam/programs/mambaforge/envs/barnacle_py311_env/lib/python3.11/site-packages/scipy/_lib/_util.py)
  TLViz FMS: Failed (Installation failed: cannot import name '_lazywhere' from 'scipy._lib._util' (/home/sam/programs/mambaforge/envs/barnacle_py311_env/lib/python3.11/site-packages/scipy/_lib/_util.py))
  Reconstruction FMS: 0.9059 (correlation: 0.8118)
  Valid elements used: 1,144,976
  Saved FMS results to: factor_match_score.json

--- Evaluating FMS for Rank 35 ---
  Loaded factor matrices - Genes: (10223, 35), Samples: (28, 35), Time: (4, 35)
  WARNING: tlviz not available for rank 35: cannot import name '_lazywhere' from 'scipy._lib._util' (/home/sam/programs/mambaforge/envs/barnacle_py311_env/lib/python3.11/site-packages/scipy/_lib/_util.py)
  Attempting to install tensorly-viz...
  Failed to install/import tlviz: cannot import name '_lazywhere' from 'scipy._lib._util' (/home/sam/programs/mambaforge/envs/barnacle_py311_env/lib/python3.11/site-packages/scipy/_lib/_util.py)
  TLViz FMS: Failed (Installation failed: cannot import name '_lazywhere' from 'scipy._lib._util' (/home/sam/programs/mambaforge/envs/barnacle_py311_env/lib/python3.11/site-packages/scipy/_lib/_util.py))
  Reconstruction FMS: 0.9341 (correlation: 0.8681)
  Valid elements used: 1,144,976
  Saved FMS results to: factor_match_score.json

--- Evaluating FMS for Rank 45 ---
  Loaded factor matrices - Genes: (10223, 45), Samples: (28, 45), Time: (4, 45)
  WARNING: tlviz not available for rank 45: cannot import name '_lazywhere' from 'scipy._lib._util' (/home/sam/programs/mambaforge/envs/barnacle_py311_env/lib/python3.11/site-packages/scipy/_lib/_util.py)
  Attempting to install tensorly-viz...
  Failed to install/import tlviz: cannot import name '_lazywhere' from 'scipy._lib._util' (/home/sam/programs/mambaforge/envs/barnacle_py311_env/lib/python3.11/site-packages/scipy/_lib/_util.py)
  TLViz FMS: Failed (Installation failed: cannot import name '_lazywhere' from 'scipy._lib._util' (/home/sam/programs/mambaforge/envs/barnacle_py311_env/lib/python3.11/site-packages/scipy/_lib/_util.py))
  Reconstruction FMS: 0.9533 (correlation: 0.9066)
  Valid elements used: 1,144,976
  Saved FMS results to: factor_match_score.json

--- Evaluating FMS for Rank 55 ---
  Loaded factor matrices - Genes: (10223, 55), Samples: (28, 55), Time: (4, 55)
  WARNING: tlviz not available for rank 55: cannot import name '_lazywhere' from 'scipy._lib._util' (/home/sam/programs/mambaforge/envs/barnacle_py311_env/lib/python3.11/site-packages/scipy/_lib/_util.py)
  Attempting to install tensorly-viz...
  Failed to install/import tlviz: cannot import name '_lazywhere' from 'scipy._lib._util' (/home/sam/programs/mambaforge/envs/barnacle_py311_env/lib/python3.11/site-packages/scipy/_lib/_util.py)
  TLViz FMS: Failed (Installation failed: cannot import name '_lazywhere' from 'scipy._lib._util' (/home/sam/programs/mambaforge/envs/barnacle_py311_env/lib/python3.11/site-packages/scipy/_lib/_util.py))
  Reconstruction FMS: 0.9663 (correlation: 0.9326)
  Valid elements used: 1,144,976
  Saved FMS results to: factor_match_score.json

--- Evaluating FMS for Rank 65 ---
  Loaded factor matrices - Genes: (10223, 65), Samples: (28, 65), Time: (4, 65)
  WARNING: tlviz not available for rank 65: cannot import name '_lazywhere' from 'scipy._lib._util' (/home/sam/programs/mambaforge/envs/barnacle_py311_env/lib/python3.11/site-packages/scipy/_lib/_util.py)
  Attempting to install tensorly-viz...
  Failed to install/import tlviz: cannot import name '_lazywhere' from 'scipy._lib._util' (/home/sam/programs/mambaforge/envs/barnacle_py311_env/lib/python3.11/site-packages/scipy/_lib/_util.py)
  TLViz FMS: Failed (Installation failed: cannot import name '_lazywhere' from 'scipy._lib._util' (/home/sam/programs/mambaforge/envs/barnacle_py311_env/lib/python3.11/site-packages/scipy/_lib/_util.py))
  Reconstruction FMS: 0.9761 (correlation: 0.9523)
  Valid elements used: 1,144,976
  Saved FMS results to: factor_match_score.json

--- Evaluating FMS for Rank 75 ---
  Loaded factor matrices - Genes: (10223, 75), Samples: (28, 75), Time: (4, 75)
  WARNING: tlviz not available for rank 75: cannot import name '_lazywhere' from 'scipy._lib._util' (/home/sam/programs/mambaforge/envs/barnacle_py311_env/lib/python3.11/site-packages/scipy/_lib/_util.py)
  Attempting to install tensorly-viz...
  Failed to install/import tlviz: cannot import name '_lazywhere' from 'scipy._lib._util' (/home/sam/programs/mambaforge/envs/barnacle_py311_env/lib/python3.11/site-packages/scipy/_lib/_util.py)
  TLViz FMS: Failed (Installation failed: cannot import name '_lazywhere' from 'scipy._lib._util' (/home/sam/programs/mambaforge/envs/barnacle_py311_env/lib/python3.11/site-packages/scipy/_lib/_util.py))
  Reconstruction FMS: 0.9838 (correlation: 0.9676)
  Valid elements used: 1,144,976
  Saved FMS results to: factor_match_score.json

============================================================
FMS RESULTS SUMMARY
============================================================
Saved FMS comparison table to: ../output/13.00-multiomics-barnacle/rank_comparison/factor_match_scores.csv

Factor Match Score Results:
 rank  fms_tlviz  fms_reconstruction  reconstruction_correlation
    5        NaN              0.7601                      0.5202
    8        NaN              0.8003                      0.6005
   10        NaN              0.8225                      0.6451
   12        NaN              0.8398                      0.6797
   15        NaN              0.8610                      0.7219
   20        NaN              0.8863                      0.7726
   25        NaN              0.9059                      0.8118
   35        NaN              0.9341                      0.8681
   45        NaN              0.9533                      0.9066
   55        NaN              0.9663                      0.9326
   65        NaN              0.9761                      0.9523
   75        NaN              0.9838                      0.9676

NOTE: TLViz FMS failed for all ranks due to SciPy version incompatibility.
This is a common issue with newer SciPy versions.
The Reconstruction FMS provides equivalent functionality and is working correctly.
[<matplotlib.lines.Line2D object at 0x78e6059c3410>]
Text(0.5, 0, 'Rank (Number of Components)')
Text(0, 0.5, 'Factor Match Score')
Text(0.5, 1.0, 'Factor Match Score vs Rank\n(Reconstruction-based FMS - Primary Metric)')
<matplotlib.legend.Legend object at 0x78e616bd9a10>
(0.0, 1.05)
[<matplotlib.lines.Line2D object at 0x78e605952010>]
<matplotlib.lines.Line2D object at 0x78e6059db7d0>
<matplotlib.lines.Line2D object at 0x78e68f619e90>
Text(0.5, 0, 'Rank (Number of Components)')
Text(0, 0.5, 'Reconstruction Correlation')
Text(0.5, 1.0, 'Tensor Reconstruction Quality vs Rank\n(Correlation between original and reconstructed)')
<matplotlib.legend.Legend object at 0x78e605c5ac50>
(-1.05, 1.05)
Saved FMS plot to: ../output/13.00-multiomics-barnacle/rank_comparison/factor_match_scores_plot.png

============================================================
FMS-BASED RANK RECOMMENDATION
============================================================
Best Reconstruction FMS: Rank 75 (score: 0.9838)
Best Reconstruction Correlation: Rank 75 (score: 0.9676)
TLViz FMS: Not available (SciPy compatibility issue)

High-scoring ranks (top 20%): [55, 65, 75]
Threshold: 0.9637

FMS Interpretation:
• Reconstruction FMS measures tensor reconstruction quality
  (correlation between original and decomposed tensors)
• Reconstruction correlation shows direct fit quality
• Higher scores indicate better factor recovery and model fit
• Reconstruction FMS is the primary metric to use for rank selection
• TLViz FMS unavailable due to SciPy version incompatibility
  (This is common and does not affect analysis quality)
• Consider ranks with consistently high Reconstruction FMS

============================================================
FACTOR MATCH SCORE EVALUATION COMPLETE
============================================================
Summary: 12/12 ranks have valid Reconstruction FMS
         0/12 ranks have valid TLViz FMS
→ Use Reconstruction FMS and correlation for rank selection

============================================================
FACTOR MATCH SCORE (FMS) EVALUATION
============================================================
This analysis evaluates decomposition quality using the Factor Match Score
from the tensorly-viz (tlviz) library, which measures how well the
decomposed factors match the original tensor structure.
============================================================
Found 12 successful ranks to evaluate: [5, 8, 10, 12, 15, 20, 25, 35, 45, 55, 65, 75]

--- Evaluating FMS for Rank 5 ---
  Loaded factors: 10223 genes, 28 samples, 4 timepoints
  TLViz FMS: Skipped (SciPy incompatibility)
  Reconstruction FMS: 0.7601 (corr: 0.5202)

--- Evaluating FMS for Rank 8 ---
  Loaded factors: 10223 genes, 28 samples, 4 timepoints
  TLViz FMS: Skipped (SciPy incompatibility)
  Reconstruction FMS: 0.8003 (corr: 0.6005)

--- Evaluating FMS for Rank 10 ---
  Loaded factors: 10223 genes, 28 samples, 4 timepoints
  TLViz FMS: Skipped (SciPy incompatibility)
  Reconstruction FMS: 0.8225 (corr: 0.6451)

--- Evaluating FMS for Rank 12 ---
  Loaded factors: 10223 genes, 28 samples, 4 timepoints
  TLViz FMS: Skipped (SciPy incompatibility)
  Reconstruction FMS: 0.8398 (corr: 0.6797)

--- Evaluating FMS for Rank 15 ---
  Loaded factors: 10223 genes, 28 samples, 4 timepoints
  TLViz FMS: Skipped (SciPy incompatibility)
  Reconstruction FMS: 0.8610 (corr: 0.7219)

--- Evaluating FMS for Rank 20 ---
  Loaded factors: 10223 genes, 28 samples, 4 timepoints
  TLViz FMS: Skipped (SciPy incompatibility)
  Reconstruction FMS: 0.8863 (corr: 0.7726)

--- Evaluating FMS for Rank 25 ---
  Loaded factors: 10223 genes, 28 samples, 4 timepoints
  TLViz FMS: Skipped (SciPy incompatibility)
  Reconstruction FMS: 0.9059 (corr: 0.8118)

--- Evaluating FMS for Rank 35 ---
  Loaded factors: 10223 genes, 28 samples, 4 timepoints
  TLViz FMS: Skipped (SciPy incompatibility)
  Reconstruction FMS: 0.9341 (corr: 0.8681)

--- Evaluating FMS for Rank 45 ---
  Loaded factors: 10223 genes, 28 samples, 4 timepoints
  TLViz FMS: Skipped (SciPy incompatibility)
  Reconstruction FMS: 0.9533 (corr: 0.9066)

--- Evaluating FMS for Rank 55 ---
  Loaded factors: 10223 genes, 28 samples, 4 timepoints
  TLViz FMS: Skipped (SciPy incompatibility)
  Reconstruction FMS: 0.9663 (corr: 0.9326)

--- Evaluating FMS for Rank 65 ---
  Loaded factors: 10223 genes, 28 samples, 4 timepoints
  TLViz FMS: Skipped (SciPy incompatibility)
  Reconstruction FMS: 0.9761 (corr: 0.9523)

--- Evaluating FMS for Rank 75 ---
  Loaded factors: 10223 genes, 28 samples, 4 timepoints
  TLViz FMS: Skipped (SciPy incompatibility)
  Reconstruction FMS: 0.9838 (corr: 0.9676)

============================================================
FMS RESULTS SUMMARY
============================================================
Saved FMS comparison table to: ../output/13.00-multiomics-barnacle/rank_comparison/factor_match_scores.csv

Factor Match Score Results:
 rank  fms_tlviz  fms_reconstruction  reconstruction_correlation
    5        NaN              0.7601                      0.5202
    8        NaN              0.8003                      0.6005
   10        NaN              0.8225                      0.6451
   12        NaN              0.8398                      0.6797
   15        NaN              0.8610                      0.7219
   20        NaN              0.8863                      0.7726
   25        NaN              0.9059                      0.8118
   35        NaN              0.9341                      0.8681
   45        NaN              0.9533                      0.9066
   55        NaN              0.9663                      0.9326
   65        NaN              0.9761                      0.9523
   75        NaN              0.9838                      0.9676

NOTE: TLViz FMS failed for all ranks due to SciPy version incompatibility.
This is a common issue with newer SciPy versions.
The Reconstruction FMS provides equivalent functionality and is working correctly.
[<matplotlib.lines.Line2D object at 0x78e605950550>]
Text(0.5, 0, 'Rank (Number of Components)')
Text(0, 0.5, 'Factor Match Score')
Text(0.5, 1.0, 'Factor Match Score vs Rank\n(Reconstruction-based FMS - Primary Metric)')
<matplotlib.legend.Legend object at 0x78e605975990>
(0.0, 1.05)
[<matplotlib.lines.Line2D object at 0x78e6058714d0>]
<matplotlib.lines.Line2D object at 0x78e60571fdd0>
<matplotlib.lines.Line2D object at 0x78e6059c1090>
Text(0.5, 0, 'Rank (Number of Components)')
Text(0, 0.5, 'Reconstruction Correlation')
Text(0.5, 1.0, 'Tensor Reconstruction Quality vs Rank\n(Correlation between original and reconstructed)')
<matplotlib.legend.Legend object at 0x78e68f6bae50>
(-1.05, 1.05)
Saved FMS plot to: ../output/13.00-multiomics-barnacle/rank_comparison/factor_match_scores_plot.png

============================================================
FMS-BASED RANK RECOMMENDATION
============================================================
Best Reconstruction FMS: Rank 75 (score: 0.9838)
Best Reconstruction Correlation: Rank 75 (score: 0.9676)
TLViz FMS: Not available (SciPy compatibility issue)

High-scoring ranks (top 20%): [55, 65, 75]
Threshold: 0.9637

FMS Interpretation:
• Reconstruction FMS measures tensor reconstruction quality
  (correlation between original and decomposed tensors)
• Reconstruction correlation shows direct fit quality
• Higher scores indicate better factor recovery and model fit
• Reconstruction FMS is the primary metric to use for rank selection
• TLViz FMS unavailable due to SciPy version incompatibility
  (This is common and does not affect analysis quality)
• Consider ranks with consistently high Reconstruction FMS

============================================================
GENERATING VISUALIZATIONS
============================================================

1. Creating FMS comparison plots...
   ✓ Saved to: ../output/13.00-multiomics-barnacle/fms_comparison_plots.png

2. Creating component weights analysis...
   ✓ Saved to: ../output/13.00-multiomics-barnacle/component_weights_analysis.png

3. Creating factor heatmaps for top ranks...
   Creating heatmaps for rank 75...
   ✓ Rank 75 heatmaps saved
   Creating heatmaps for rank 65...
   ✓ Rank 65 heatmaps saved
   Creating heatmaps for rank 55...
   ✓ Rank 55 heatmaps saved

============================================================
VISUALIZATION GENERATION COMPLETE
============================================================

Generated visualizations:
• fms_comparison_plots.png - Comprehensive FMS analysis across ranks
• component_weights_analysis.png - Component weights distribution
• factor_heatmaps.png (in rank_XX directories) - Factor matrix visualizations

These plots provide:
• Visual comparison of FMS scores and reconstruction quality
• Component importance analysis across different decomposition ranks
• Detailed factor patterns for best-performing ranks

============================================================
FACTOR MATCH SCORE EVALUATION COMPLETE
============================================================
Summary: 12/12 ranks have valid Reconstruction FMS
         0/12 ranks have valid TLViz FMS
→ Use Reconstruction FMS and correlation for rank selection

============================================================
FACTOR MATCH SCORE (FMS) EVALUATION
============================================================
This analysis evaluates decomposition quality using the Factor Match Score
from the tensorly-viz (tlviz) library, which measures how well the
decomposed factors match the original tensor structure.
============================================================
Found 12 successful ranks to evaluate: [5, 8, 10, 12, 15, 20, 25, 35, 45, 55, 65, 75]

--- Evaluating FMS for Rank 5 ---
  Loaded factors: 10223 genes, 28 samples, 4 timepoints
  TLViz FMS: Failed
  Reconstruction FMS: 0.7601 (corr: 0.5202)

--- Evaluating FMS for Rank 8 ---
  Loaded factors: 10223 genes, 28 samples, 4 timepoints
  TLViz FMS: Failed
  Reconstruction FMS: 0.8003 (corr: 0.6005)

--- Evaluating FMS for Rank 10 ---
  Loaded factors: 10223 genes, 28 samples, 4 timepoints
  TLViz FMS: Failed
  Reconstruction FMS: 0.8225 (corr: 0.6451)

--- Evaluating FMS for Rank 12 ---
  Loaded factors: 10223 genes, 28 samples, 4 timepoints
  TLViz FMS: Failed
  Reconstruction FMS: 0.8398 (corr: 0.6797)

--- Evaluating FMS for Rank 15 ---
  Loaded factors: 10223 genes, 28 samples, 4 timepoints
  TLViz FMS: Failed
  Reconstruction FMS: 0.8610 (corr: 0.7219)

--- Evaluating FMS for Rank 20 ---
  Loaded factors: 10223 genes, 28 samples, 4 timepoints
  TLViz FMS: Failed
  Reconstruction FMS: 0.8863 (corr: 0.7726)

--- Evaluating FMS for Rank 25 ---
  Loaded factors: 10223 genes, 28 samples, 4 timepoints
  TLViz FMS: Failed
  Reconstruction FMS: 0.9059 (corr: 0.8118)

--- Evaluating FMS for Rank 35 ---
  Loaded factors: 10223 genes, 28 samples, 4 timepoints
  TLViz FMS: Failed
  Reconstruction FMS: 0.9341 (corr: 0.8681)

--- Evaluating FMS for Rank 45 ---
  Loaded factors: 10223 genes, 28 samples, 4 timepoints
  TLViz FMS: Failed
  Reconstruction FMS: 0.9533 (corr: 0.9066)

--- Evaluating FMS for Rank 55 ---
  Loaded factors: 10223 genes, 28 samples, 4 timepoints
  TLViz FMS: Failed
  Reconstruction FMS: 0.9663 (corr: 0.9326)

--- Evaluating FMS for Rank 65 ---
  Loaded factors: 10223 genes, 28 samples, 4 timepoints
  TLViz FMS: Failed
  Reconstruction FMS: 0.9761 (corr: 0.9523)

--- Evaluating FMS for Rank 75 ---
  Loaded factors: 10223 genes, 28 samples, 4 timepoints
  TLViz FMS: Failed
  Reconstruction FMS: 0.9838 (corr: 0.9676)

============================================================
FMS RESULTS SUMMARY
============================================================
Saved FMS comparison table to: ../output/13.00-multiomics-barnacle/rank_comparison/factor_match_scores.csv

Factor Match Score Results:
 rank  fms_tlviz  fms_reconstruction  reconstruction_correlation
    5        NaN              0.7601                      0.5202
    8        NaN              0.8003                      0.6005
   10        NaN              0.8225                      0.6451
   12        NaN              0.8398                      0.6797
   15        NaN              0.8610                      0.7219
   20        NaN              0.8863                      0.7726
   25        NaN              0.9059                      0.8118
   35        NaN              0.9341                      0.8681
   45        NaN              0.9533                      0.9066
   55        NaN              0.9663                      0.9326
   65        NaN              0.9761                      0.9523
   75        NaN              0.9838                      0.9676

✓ Reconstruction FMS is working successfully for 12/12 ranks
  Using correlation-based reconstruction quality metrics for rank selection.
  Note: TLViz unavailable due to package compatibility - using reconstruction FMS instead.
[<matplotlib.lines.Line2D object at 0x78e5e2f750d0>]
Text(0.5, 0, 'Rank (Number of Components)')
Text(0, 0.5, 'Factor Match Score')
Text(0.5, 1.0, 'Factor Match Score vs Rank\n(Reconstruction-based FMS - Primary Metric)')
<matplotlib.legend.Legend object at 0x78e5e358ac90>
(0.0, 1.05)
[<matplotlib.lines.Line2D object at 0x78e5fd0194d0>]
<matplotlib.lines.Line2D object at 0x78e5fd02c290>
<matplotlib.lines.Line2D object at 0x78e5e2f75250>
Text(0.5, 0, 'Rank (Number of Components)')
Text(0, 0.5, 'Reconstruction Correlation')
Text(0.5, 1.0, 'Tensor Reconstruction Quality vs Rank\n(Correlation between original and reconstructed)')
<matplotlib.legend.Legend object at 0x78e5fd018bd0>
(-1.05, 1.05)
Saved FMS plot to: ../output/13.00-multiomics-barnacle/rank_comparison/factor_match_scores_plot.png

============================================================
FMS-BASED RANK RECOMMENDATION
============================================================
Best Reconstruction FMS: Rank 75 (score: 0.9838)
Best Reconstruction Correlation: Rank 75 (score: 0.9676)
TLViz FMS: Not available (SciPy compatibility issue)

High-scoring ranks (top 20%): [55, 65, 75]
Threshold: 0.9637

FMS Interpretation:
• Reconstruction FMS measures tensor reconstruction quality
  (correlation between original and decomposed tensors)
• Reconstruction correlation shows direct fit quality
• Higher scores indicate better factor recovery and model fit
• Reconstruction FMS is the primary metric to use for rank selection
• TLViz FMS unavailable due to SciPy version incompatibility
  (This is common and does not affect analysis quality)
• Consider ranks with consistently high Reconstruction FMS

============================================================
GENERATING VISUALIZATIONS
============================================================

1. Creating FMS comparison plots...
   ✓ Saved to: ../output/13.00-multiomics-barnacle/fms_comparison_plots.png

2. Creating component weights analysis...
   ✓ Saved to: ../output/13.00-multiomics-barnacle/component_weights_analysis.png

3. Creating factor heatmaps for top ranks...
   Creating heatmaps for rank 75...
   ✓ Rank 75 heatmaps saved
   Creating heatmaps for rank 65...
   ✓ Rank 65 heatmaps saved
   Creating heatmaps for rank 55...
   ✓ Rank 55 heatmaps saved

============================================================
VISUALIZATION GENERATION COMPLETE
============================================================

Generated visualizations:
• fms_comparison_plots.png - Comprehensive FMS analysis across ranks
• component_weights_analysis.png - Component weights distribution
• factor_heatmaps.png (in rank_XX directories) - Factor matrix visualizations

These plots provide:
• Visual comparison of FMS scores and reconstruction quality
• Component importance analysis across different decomposition ranks
• Detailed factor patterns for best-performing ranks

============================================================
FACTOR MATCH SCORE EVALUATION COMPLETE
============================================================
Summary: 12/12 ranks have valid Reconstruction FMS
         0/12 ranks have valid TLViz FMS
→ Use Reconstruction FMS and correlation for rank selection

============================================================
FACTOR MATCH SCORE (FMS) EVALUATION
============================================================
This analysis evaluates decomposition quality using the Factor Match Score
from the tensorly-viz (tlviz) library, which measures how well the
decomposed factors match the original tensor structure.
============================================================
Found 12 successful ranks to evaluate: [5, 8, 10, 12, 15, 20, 25, 35, 45, 55, 65, 75]

--- Evaluating FMS for Rank 5 ---
  Loaded factors: 10223 genes, 28 samples, 4 timepoints
  TLViz FMS: Failed
  Reconstruction FMS: 0.7601 (corr: 0.5202)

--- Evaluating FMS for Rank 8 ---
  Loaded factors: 10223 genes, 28 samples, 4 timepoints
  TLViz FMS: Failed
  Reconstruction FMS: 0.8003 (corr: 0.6005)

--- Evaluating FMS for Rank 10 ---
  Loaded factors: 10223 genes, 28 samples, 4 timepoints
  TLViz FMS: Failed
  Reconstruction FMS: 0.8225 (corr: 0.6451)

--- Evaluating FMS for Rank 12 ---
  Loaded factors: 10223 genes, 28 samples, 4 timepoints
  TLViz FMS: Failed
  Reconstruction FMS: 0.8398 (corr: 0.6797)

--- Evaluating FMS for Rank 15 ---
  Loaded factors: 10223 genes, 28 samples, 4 timepoints
  TLViz FMS: Failed
  Reconstruction FMS: 0.8610 (corr: 0.7219)

--- Evaluating FMS for Rank 20 ---
  Loaded factors: 10223 genes, 28 samples, 4 timepoints
  TLViz FMS: Failed
  Reconstruction FMS: 0.8863 (corr: 0.7726)

--- Evaluating FMS for Rank 25 ---
  Loaded factors: 10223 genes, 28 samples, 4 timepoints
  TLViz FMS: Failed
  Reconstruction FMS: 0.9059 (corr: 0.8118)

--- Evaluating FMS for Rank 35 ---
  Loaded factors: 10223 genes, 28 samples, 4 timepoints
  TLViz FMS: Failed
  Reconstruction FMS: 0.9341 (corr: 0.8681)

--- Evaluating FMS for Rank 45 ---
  Loaded factors: 10223 genes, 28 samples, 4 timepoints
  TLViz FMS: Failed
  Reconstruction FMS: 0.9533 (corr: 0.9066)

--- Evaluating FMS for Rank 55 ---
  Loaded factors: 10223 genes, 28 samples, 4 timepoints
  TLViz FMS: Failed
  Reconstruction FMS: 0.9663 (corr: 0.9326)

--- Evaluating FMS for Rank 65 ---
  Loaded factors: 10223 genes, 28 samples, 4 timepoints
  TLViz FMS: Failed
  Reconstruction FMS: 0.9761 (corr: 0.9523)

--- Evaluating FMS for Rank 75 ---
  Loaded factors: 10223 genes, 28 samples, 4 timepoints
  TLViz FMS: Failed
  Reconstruction FMS: 0.9838 (corr: 0.9676)

============================================================
FMS RESULTS SUMMARY
============================================================
Saved FMS comparison table to: ../output/13.00-multiomics-barnacle/rank_comparison/factor_match_scores.csv

Factor Match Score Results:
 rank  fms_reconstruction  reconstruction_correlation
    5              0.7601                      0.5202
    8              0.8003                      0.6005
   10              0.8225                      0.6451
   12              0.8398                      0.6797
   15              0.8610                      0.7219
   20              0.8863                      0.7726
   25              0.9059                      0.8118
   35              0.9341                      0.8681
   45              0.9533                      0.9066
   55              0.9663                      0.9326
   65              0.9761                      0.9523
   75              0.9838                      0.9676

✓ Reconstruction FMS is working successfully for 12/12 ranks
  Using correlation-based reconstruction quality metrics for rank selection.
  Note: TLViz unavailable due to package compatibility - using reconstruction FMS instead.
[<matplotlib.lines.Line2D object at 0x78e5fce050d0>]
Text(0.5, 0, 'Rank (Number of Components)')
Text(0, 0.5, 'Factor Match Score')
Text(0.5, 1.0, 'Factor Match Score vs Rank\n(Reconstruction-based FMS - Primary Metric)')
<matplotlib.legend.Legend object at 0x78e5d1ca7b90>
(0.0, 1.05)
[<matplotlib.lines.Line2D object at 0x78e5e3185190>]
<matplotlib.lines.Line2D object at 0x78e5f469fed0>
<matplotlib.lines.Line2D object at 0x78e5fcf8ec90>
Text(0.5, 0, 'Rank (Number of Components)')
Text(0, 0.5, 'Reconstruction Correlation')
Text(0.5, 1.0, 'Tensor Reconstruction Quality vs Rank\n(Correlation between original and reconstructed)')
<matplotlib.legend.Legend object at 0x78e5f47a5f10>
(-1.05, 1.05)
Saved FMS plot to: ../output/13.00-multiomics-barnacle/rank_comparison/factor_match_scores_plot.png

============================================================
FMS-BASED RANK RECOMMENDATION
============================================================
Best Reconstruction FMS: Rank 75 (score: 0.9838)
Best Reconstruction Correlation: Rank 75 (score: 0.9676)
TLViz FMS: Not available (SciPy compatibility issue)

High-scoring ranks (top 20%): [55, 65, 75]
Threshold: 0.9637

FMS Interpretation:
• Reconstruction FMS measures tensor reconstruction quality
  (correlation between original and decomposed tensors)
• Reconstruction correlation shows direct fit quality
• Higher scores indicate better factor recovery and model fit
• Reconstruction FMS is the primary metric to use for rank selection
• TLViz FMS unavailable due to SciPy version incompatibility
  (This is common and does not affect analysis quality)
• Consider ranks with consistently high Reconstruction FMS

============================================================
GENERATING VISUALIZATIONS
============================================================

1. Creating FMS comparison plots...
   ✓ Saved to: ../output/13.00-multiomics-barnacle/fms_comparison_plots.png

2. Creating component weights analysis...
   ✓ Saved to: ../output/13.00-multiomics-barnacle/component_weights_analysis.png

3. Creating factor heatmaps for top ranks...
   Creating heatmaps for rank 75...
   ✓ Rank 75 heatmaps saved
   Creating heatmaps for rank 65...
   ✓ Rank 65 heatmaps saved
   Creating heatmaps for rank 55...
   ✓ Rank 55 heatmaps saved

============================================================
VISUALIZATION GENERATION COMPLETE
============================================================

Generated visualizations:
• fms_comparison_plots.png - Comprehensive FMS analysis across ranks
• component_weights_analysis.png - Component weights distribution
• factor_heatmaps.png (in rank_XX directories) - Factor matrix visualizations

These plots provide:
• Visual comparison of FMS scores and reconstruction quality
• Component importance analysis across different decomposition ranks
• Detailed factor patterns for best-performing ranks

============================================================
FACTOR MATCH SCORE EVALUATION COMPLETE
============================================================
Summary: 12/12 ranks have valid Reconstruction FMS
         0/12 ranks have valid TLViz FMS
→ Use Reconstruction FMS and correlation for rank selection

============================================================
FACTOR MATCH SCORE (FMS) EVALUATION
============================================================
This analysis evaluates decomposition quality using the Factor Match Score
from the tensorly-viz (tlviz) library, which measures how well the
decomposed factors match the original tensor structure.
============================================================
Found 12 successful ranks to evaluate: [5, 8, 10, 12, 15, 20, 25, 35, 45, 55, 65, 75]

--- Evaluating FMS for Rank 5 ---
  Loaded factors: 10223 genes, 28 samples, 4 timepoints
  TLViz FMS: Failed
  Reconstruction FMS: 0.7601 (corr: 0.5202)

--- Evaluating FMS for Rank 8 ---
  Loaded factors: 10223 genes, 28 samples, 4 timepoints
  TLViz FMS: Failed
  Reconstruction FMS: 0.8003 (corr: 0.6005)

--- Evaluating FMS for Rank 10 ---
  Loaded factors: 10223 genes, 28 samples, 4 timepoints
  TLViz FMS: Failed
  Reconstruction FMS: 0.8225 (corr: 0.6451)

--- Evaluating FMS for Rank 12 ---
  Loaded factors: 10223 genes, 28 samples, 4 timepoints
  TLViz FMS: Failed
  Reconstruction FMS: 0.8398 (corr: 0.6797)

--- Evaluating FMS for Rank 15 ---
  Loaded factors: 10223 genes, 28 samples, 4 timepoints
  TLViz FMS: Failed
  Reconstruction FMS: 0.8610 (corr: 0.7219)

--- Evaluating FMS for Rank 20 ---
  Loaded factors: 10223 genes, 28 samples, 4 timepoints
  TLViz FMS: Failed
  Reconstruction FMS: 0.8863 (corr: 0.7726)

--- Evaluating FMS for Rank 25 ---
  Loaded factors: 10223 genes, 28 samples, 4 timepoints
  TLViz FMS: Failed
  Reconstruction FMS: 0.9059 (corr: 0.8118)

--- Evaluating FMS for Rank 35 ---
  Loaded factors: 10223 genes, 28 samples, 4 timepoints
  TLViz FMS: Failed
  Reconstruction FMS: 0.9341 (corr: 0.8681)

--- Evaluating FMS for Rank 45 ---
  Loaded factors: 10223 genes, 28 samples, 4 timepoints
  TLViz FMS: Failed
  Reconstruction FMS: 0.9533 (corr: 0.9066)

--- Evaluating FMS for Rank 55 ---
  Loaded factors: 10223 genes, 28 samples, 4 timepoints
  TLViz FMS: Failed
  Reconstruction FMS: 0.9663 (corr: 0.9326)

--- Evaluating FMS for Rank 65 ---
  Loaded factors: 10223 genes, 28 samples, 4 timepoints
  TLViz FMS: Failed
  Reconstruction FMS: 0.9761 (corr: 0.9523)

--- Evaluating FMS for Rank 75 ---
  Loaded factors: 10223 genes, 28 samples, 4 timepoints
  TLViz FMS: Failed
  Reconstruction FMS: 0.9838 (corr: 0.9676)

============================================================
FMS RESULTS SUMMARY
============================================================
Saved FMS comparison table to: ../output/13.00-multiomics-barnacle/rank_comparison/factor_match_scores.csv

Factor Match Score Results:
 rank  fms_reconstruction  reconstruction_correlation
    5              0.7601                      0.5202
    8              0.8003                      0.6005
   10              0.8225                      0.6451
   12              0.8398                      0.6797
   15              0.8610                      0.7219
   20              0.8863                      0.7726
   25              0.9059                      0.8118
   35              0.9341                      0.8681
   45              0.9533                      0.9066
   55              0.9663                      0.9326
   65              0.9761                      0.9523
   75              0.9838                      0.9676

✓ Reconstruction FMS is working successfully for 12/12 ranks
  Using correlation-based reconstruction quality metrics for rank selection.
  Note: TLViz unavailable due to package compatibility - using reconstruction FMS instead.
[<matplotlib.lines.Line2D object at 0x78e5fd3f6110>]
Text(0.5, 0, 'Rank (Number of Components)')
Text(0, 0.5, 'Factor Match Score')
Text(0.5, 1.0, 'Factor Match Score vs Rank\n(Reconstruction-based FMS - Primary Metric)')
<matplotlib.legend.Legend object at 0x78e5e305ee50>
(0.0, 1.05)
[<matplotlib.lines.Line2D object at 0x78e5e354de10>]
<matplotlib.lines.Line2D object at 0x78e5ec194cd0>
<matplotlib.lines.Line2D object at 0x78e5f44fac10>
Text(0.5, 0, 'Rank (Number of Components)')
Text(0, 0.5, 'Reconstruction Correlation')
Text(0.5, 1.0, 'Tensor Reconstruction Quality vs Rank\n(Correlation between original and reconstructed)')
<matplotlib.legend.Legend object at 0x78e68f604f50>
(-1.05, 1.05)
Saved FMS plot to: ../output/13.00-multiomics-barnacle/rank_comparison/factor_match_scores_plot.png

============================================================
FMS-BASED RANK RECOMMENDATION
============================================================
Best Reconstruction FMS: Rank 75 (score: 0.9838)
Best Reconstruction Correlation: Rank 75 (score: 0.9676)
TLViz FMS: Not available (SciPy compatibility issue)

High-scoring ranks (top 20%): [55, 65, 75]
Threshold: 0.9637

FMS Interpretation:
• Reconstruction FMS measures tensor reconstruction quality
  (correlation between original and decomposed tensors)
• Reconstruction correlation shows direct fit quality
• Higher scores indicate better factor recovery and model fit
• Reconstruction FMS is the primary metric to use for rank selection
• TLViz FMS unavailable due to SciPy version incompatibility
  (This is common and does not affect analysis quality)
• Consider ranks with consistently high Reconstruction FMS

============================================================
GENERATING VISUALIZATIONS
============================================================

1. Creating FMS comparison plots...
   ✓ Saved to: ../output/13.00-multiomics-barnacle/fms_comparison_plots.png

2. Creating component weights analysis...
   ✓ Saved to: ../output/13.00-multiomics-barnacle/component_weights_analysis.png

3. Creating factor heatmaps for top ranks...
   Creating heatmaps for rank 75...
   ✓ Rank 75 heatmaps saved
   Creating heatmaps for rank 65...
   ✓ Rank 65 heatmaps saved
   Creating heatmaps for rank 55...
   ✓ Rank 55 heatmaps saved

============================================================
VISUALIZATION GENERATION COMPLETE
============================================================

Generated visualizations:
• fms_comparison_plots.png - Comprehensive FMS analysis across ranks
• component_weights_analysis.png - Component weights distribution
• factor_heatmaps.png (in rank_XX directories) - Factor matrix visualizations

These plots provide:
• Visual comparison of FMS scores and reconstruction quality
• Component importance analysis across different decomposition ranks
• Detailed factor patterns for best-performing ranks

============================================================
FACTOR MATCH SCORE EVALUATION COMPLETE
============================================================
Summary: 12/12 ranks have valid Reconstruction FMS
         0/12 ranks have valid TLViz FMS
→ Use Reconstruction FMS and correlation for rank selection

============================================================
FACTOR MATCH SCORE (FMS) EVALUATION
============================================================
This analysis evaluates decomposition quality using the Factor Match Score
which measures how well the decomposed factors reconstruct the original
tensor structure (correlation-based reconstruction quality metric).
============================================================
Found 12 successful ranks to evaluate: [5, 8, 10, 12, 15, 20, 25, 35, 45, 55, 65, 75]

--- Evaluating FMS for Rank 5 ---
  Loaded factor matrices - Genes: (10223, 5), Samples: (28, 5), Time: (4, 5)
  FMS: 0.7601
  Correlation: 0.5202
  R²: 0.2706
  RMSE: 1.0466
  Valid elements used: 1,144,976
  Saved FMS results to: factor_match_score.json

--- Evaluating FMS for Rank 8 ---
  Loaded factor matrices - Genes: (10223, 8), Samples: (28, 8), Time: (4, 8)
  FMS: 0.8003
  Correlation: 0.6005
  R²: 0.3606
  RMSE: 0.9799
  Valid elements used: 1,144,976
  Saved FMS results to: factor_match_score.json

--- Evaluating FMS for Rank 10 ---
  Loaded factor matrices - Genes: (10223, 10), Samples: (28, 10), Time: (4, 10)
  FMS: 0.8225
  Correlation: 0.6451
  R²: 0.4161
  RMSE: 0.9364
  Valid elements used: 1,144,976
  Saved FMS results to: factor_match_score.json

--- Evaluating FMS for Rank 12 ---
  Loaded factor matrices - Genes: (10223, 12), Samples: (28, 12), Time: (4, 12)
  FMS: 0.8398
  Correlation: 0.6797
  R²: 0.4619
  RMSE: 0.8989
  Valid elements used: 1,144,976
  Saved FMS results to: factor_match_score.json

--- Evaluating FMS for Rank 15 ---
  Loaded factor matrices - Genes: (10223, 15), Samples: (28, 15), Time: (4, 15)
  FMS: 0.8610
  Correlation: 0.7219
  R²: 0.5211
  RMSE: 0.8480
  Valid elements used: 1,144,976
  Saved FMS results to: factor_match_score.json

--- Evaluating FMS for Rank 20 ---
  Loaded factor matrices - Genes: (10223, 20), Samples: (28, 20), Time: (4, 20)
  FMS: 0.8863
  Correlation: 0.7726
  R²: 0.5969
  RMSE: 0.7780
  Valid elements used: 1,144,976
  Saved FMS results to: factor_match_score.json

--- Evaluating FMS for Rank 25 ---
  Loaded factor matrices - Genes: (10223, 25), Samples: (28, 25), Time: (4, 25)
  FMS: 0.9059
  Correlation: 0.8118
  R²: 0.6590
  RMSE: 0.7156
  Valid elements used: 1,144,976
  Saved FMS results to: factor_match_score.json

--- Evaluating FMS for Rank 35 ---
  Loaded factor matrices - Genes: (10223, 35), Samples: (28, 35), Time: (4, 35)
  FMS: 0.9341
  Correlation: 0.8681
  R²: 0.7536
  RMSE: 0.6083
  Valid elements used: 1,144,976
  Saved FMS results to: factor_match_score.json

--- Evaluating FMS for Rank 45 ---
  Loaded factor matrices - Genes: (10223, 45), Samples: (28, 45), Time: (4, 45)
  FMS: 0.9533
  Correlation: 0.9066
  R²: 0.8219
  RMSE: 0.5172
  Valid elements used: 1,144,976
  Saved FMS results to: factor_match_score.json

--- Evaluating FMS for Rank 55 ---
  Loaded factor matrices - Genes: (10223, 55), Samples: (28, 55), Time: (4, 55)
  FMS: 0.9663
  Correlation: 0.9326
  R²: 0.8698
  RMSE: 0.4421
  Valid elements used: 1,144,976
  Saved FMS results to: factor_match_score.json

--- Evaluating FMS for Rank 65 ---
  Loaded factor matrices - Genes: (10223, 65), Samples: (28, 65), Time: (4, 65)
  FMS: 0.9761
  Correlation: 0.9523
  R²: 0.9068
  RMSE: 0.3741
  Valid elements used: 1,144,976
  Saved FMS results to: factor_match_score.json

--- Evaluating FMS for Rank 75 ---
  Loaded factor matrices - Genes: (10223, 75), Samples: (28, 75), Time: (4, 75)
  FMS: 0.9838
  Correlation: 0.9676
  R²: 0.9363
  RMSE: 0.3093
  Valid elements used: 1,144,976
  Saved FMS results to: factor_match_score.json

============================================================
FMS RESULTS SUMMARY
============================================================
Saved FMS comparison table to: ../output/13.00-multiomics-barnacle/rank_comparison/factor_match_scores.csv

Factor Match Score Results:
 rank    fms  correlation  r_squared   rmse
    5 0.7601       0.5202     0.2706 1.0466
    8 0.8003       0.6005     0.3606 0.9799
   10 0.8225       0.6451     0.4161 0.9364
   12 0.8398       0.6797     0.4619 0.8989
   15 0.8610       0.7219     0.5211 0.8480
   20 0.8863       0.7726     0.5969 0.7780
   25 0.9059       0.8118     0.6590 0.7156
   35 0.9341       0.8681     0.7536 0.6083
   45 0.9533       0.9066     0.8219 0.5172
   55 0.9663       0.9326     0.8698 0.4421
   65 0.9761       0.9523     0.9068 0.3741
   75 0.9838       0.9676     0.9363 0.3093
[<matplotlib.lines.Line2D object at 0x78e6058553d0>]
Text(0.5, 0, 'Rank (Number of Components)')
Text(0, 0.5, 'Factor Match Score')
Text(0.5, 1.0, 'Factor Match Score vs Rank\n(Higher = Better Factor Recovery)')
(0.0, 1.05)
[<matplotlib.lines.Line2D object at 0x78e5c9501dd0>]
<matplotlib.lines.Line2D object at 0x78e5fce07910>
<matplotlib.lines.Line2D object at 0x78e5e379fa10>
Text(0.5, 0, 'Rank (Number of Components)')
Text(0, 0.5, 'Reconstruction Correlation')
Text(0.5, 1.0, 'Tensor Reconstruction Quality vs Rank\n(Correlation between original and reconstructed)')
<matplotlib.legend.Legend object at 0x78e5fcff0bd0>
(-1.05, 1.05)
[<matplotlib.lines.Line2D object at 0x78e5c98f1550>]
<matplotlib.lines.Line2D object at 0x78e5c932a650>
<matplotlib.lines.Line2D object at 0x78e5c98f2b90>
Text(0.5, 0, 'Rank (Number of Components)')
Text(0, 0.5, 'R² (Coefficient of Determination)')
Text(0.5, 1.0, 'R² vs Rank\n(Proportion of Variance Explained)')
<matplotlib.legend.Legend object at 0x78e605df4090>
(0.0, 1.05)
[<matplotlib.lines.Line2D object at 0x78e5c98b7f50>]
Text(0.5, 0, 'Rank (Number of Components)')
Text(0, 0.5, 'RMSE (Root Mean Squared Error)')
Text(0.5, 1.0, 'Reconstruction Error vs Rank\n(Lower = Better Fit)')
Saved FMS plot to: ../output/13.00-multiomics-barnacle/rank_comparison/factor_match_scores_plot.png

============================================================
FMS-BASED RANK RECOMMENDATION
============================================================
Best FMS: Rank 75 (score: 0.9838)
Best Correlation: Rank 75 (score: 0.9676)
Best R²: Rank 75 (score: 0.9363)
Lowest RMSE: Rank 75 (error: 0.3093)

High-scoring ranks (top 20% by FMS): [55, 65, 75]
FMS threshold: 0.9637

FMS Interpretation:
• FMS measures tensor reconstruction quality (0-1 scale, higher is better)
• Correlation shows linear relationship between original and reconstructed
• R² shows proportion of variance explained (0-1 scale, higher is better)
• RMSE shows average reconstruction error (lower is better)
• Higher FMS, correlation, and R² indicate better factor recovery
• Consider ranks with consistently high FMS and R² scores
• Look for diminishing returns (elbow point) in improvement curves

============================================================
FACTOR MATCH SCORE EVALUATION COMPLETE
============================================================
Summary: 12/12 ranks have valid FMS results
→ Use FMS, correlation, and R² for rank selection
→ Results saved to: ../output/13.00-multiomics-barnacle/rank_comparison
