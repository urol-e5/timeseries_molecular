---
title: "28-rank35-lg02"
output: html_document
date: "2025-11-06"
---

```
LAMBDAS_GENE="0.00 0.01 0.05 0.1 0.2 0.4 0.8"
LAMBDA_SAMPLE=0.1
LAMBDA_TIME=0.05
RANK=35


OUTDIR_BASE=../output/26-rank35-optimization

for LG in $LAMBDAS_GENE; do
  OUTDIR=${OUTDIR_BASE}/lambda_gene_${LG}
  mkdir -p "$OUTDIR"

  /Users/sr320/.local/bin/uv run python ../scripts/14.1-barnacle/build_tensor_and_run.py \
    --input-file ../output/14-pca-orthologs/vst_counts_matrix.csv \
    --output-dir "$OUTDIR" \
    --rank $RANK \
    --lambda-gene $LG \
    --lambda-sample $LAMBDA_SAMPLE \
    --lambda-time $LAMBDA_TIME \
    --max-iter 2000 \
    --tol 1e-5 \
    --seed 81
done
```


# Gene Factor Sparse Table


```{r}
library(tidyverse)

# Use absolute or correctly relative path
base_dir <- "../output/26-rank35-optimization"
lambda_values <- c("0.00", "0.01", "0.05", "0.1", "0.2", "0.4", "0.8")

thr <- 1.0  # threshold for "high" loading

analyze_lambda <- function(lambda) {
  f <- file.path(base_dir, paste0("lambda_gene_", lambda), "barnacle_factors", "gene_factors.csv")
  
  if (!file.exists(f)) {
    stop(paste("Missing file:", f))
  }
  
  df <- read_csv(f)
  mat <- df %>%
    column_to_rownames(var = colnames(df)[1]) %>%
    as.matrix()
  
  amat <- abs(mat)
  sparsity <- mean(amat <= thr)
  overlap <- rowSums(amat > thr)
  
  tibble(
    lambda_gene = lambda,
    gene_sparsity = sparsity,
    mean_overlap = mean(overlap),
    median_overlap = median(overlap),
    frac_single_component = mean(overlap == 1),
    frac_multi_component = mean(overlap >= 2)
  )
}

summary_df <- map_dfr(lambda_values, analyze_lambda)
print(summary_df)
```


	•	λ = 0.20–0.40 → good regime:
	•	~50 % of genes belong to a single component
	•	mean overlap ≈ 1–1.5
	•	sparsity high (0.95–0.97) but not total collapse.
	
	
	
# Visualizing
	
	
	
```{r,echo=FALSE, warning=FALSE, message=FALSE}
library(tidyverse)
library(pheatmap)
```

```{bash}
head ../output/13.00-multiomics-barnacle/rank_35/gene_factors.csv
```

```{bash}
head ../output/26-rank35-optimization/lambda_gene_0.2/barnacle_factors/gene_factors.csv
```
```{bash}
head ../output/26-rank35-optimization/lambda_gene_0.2/barnacle_factors/sample_factors.csv
```

```{bash}
head ../output/26-rank35-optimization/lambda_gene_0.2/barnacle_factors/time_factors.csv
```


```{r}
# Path to your CSV file
csv_path <- "../output/26-rank35-optimization/lambda_gene_0.2/barnacle_factors/gene_factors.csv"

# Read all lines
lines <- readLines(csv_path)

# Create new header
new_header <- paste(
  c("OG_ID", paste0("Component_", 1:35)),
  collapse = ","
)

# Replace the first line
lines[1] <- new_header

# Write updated file
writeLines(lines, csv_path)

cat("✅ Header updated successfully!\n")
```

```{r}
# Path to your CSV file
csv_path <- "../output/26-rank35-optimization/lambda_gene_0.2/barnacle_factors/time_factors.csv"

# Read all lines
lines <- readLines(csv_path)

# Create new header
new_header <- paste(
  c("OG_ID", paste0("Component_", 1:35)),
  collapse = ","
)

# Replace the first line
lines[1] <- new_header

# Write updated file
writeLines(lines, csv_path)

cat("✅ Header updated successfully!\n")
```

```{r}
# Path to your CSV file
csv_path <- "../output/26-rank35-optimization/lambda_gene_0.2/barnacle_factors/sample_factors.csv"

# Read all lines
lines <- readLines(csv_path)

# Create new header
new_header <- paste(
  c("OG_ID", paste0("Component_", 1:35)),
  collapse = ","
)

# Replace the first line
lines[1] <- new_header

# Write updated file
writeLines(lines, csv_path)

cat("✅ Header updated successfully!\n")
```



	

# Samples



```{r fig.width=12, fig.height=10}
# Load required libraries
library(readr)
library(pheatmap)

# Read the CSV (adjust the filename if needed)
df <- read_csv("../output/26-rank35-optimization/lambda_gene_0.2/barnacle_factors/sample_factors.csv")

# Make the first column row names
df_mat <- df |> 
  column_to_rownames(var = colnames(df)[1]) |> 
  as.matrix()

# Optional: scale rows or columns for better contrast
df_scaled <- scale(df_mat)

# Plot heatmap
pheatmap(df_scaled,
         color = colorRampPalette(c("navy","white","firebrick3"))(100),
         clustering_method = "ward.D2",
         show_rownames = TRUE,
         show_colnames = TRUE,
         main = "Heatmap of Samples vs Features")
```
# Time

```{r}
library(tidyverse)

# File path
file_path <- "../output/26-rank35-optimization/lambda_gene_0.2/barnacle_factors/time_factors.csv"

# Read the CSV
df <- read_csv(file_path)

# Pivot to long format for plotting
df_long <- df %>%
  pivot_longer(
    cols = starts_with("Component_"),
    names_to = "Component",
    values_to = "Value"
  )

# Line plot
ggplot(df_long, aes(x = OG_ID, y = Value, group = Component, color = Component)) +
  geom_line(linewidth = 1) +
  geom_point(size = 2) +
  theme_minimal(base_size = 14) +
  theme(
    axis.text.x = element_text(angle = 45, hjust = 1),
    legend.position = "right"
  ) +
  labs(
    title = "Time Factor Loadings Across Components",
    x = "Time Point",
    y = "Loading Value"
  )
```

```{r}
library(tidyverse)

# File path
file_path <- "../output/26-rank35-optimization/lambda_gene_0.2/barnacle_factors/time_factors.csv"

# Read data
df <- read_csv(file_path)

# Compute variance of each component across timepoints
var_components <- df %>%
  pivot_longer(cols = starts_with("Component_"),
               names_to = "Component",
               values_to = "Value") %>%
  group_by(Component) %>%
  summarise(Variance = var(Value, na.rm = TRUE)) %>%
  arrange(desc(Variance))

# Select top 10 most variable components
top10_components <- var_components %>% slice_max(Variance, n = 10) %>% pull(Component)

# Prepare data for plotting
df_long <- df %>%
  pivot_longer(cols = starts_with("Component_"),
               names_to = "Component",
               values_to = "Value") %>%
  filter(Component %in% top10_components)

# Line plot
ggplot(df_long, aes(x = OG_ID, y = Value, group = Component, color = Component)) +
  geom_line(linewidth = 1.2) +
  geom_point(size = 2) +
  theme_minimal(base_size = 14) +
  theme(axis.text.x = element_text(angle = 45, hjust = 1)) +
  labs(
    title = "Top 10 Most Variable Components Across Timepoints",
    x = "Time Point",
    y = "Component Value"
  )
```

# Pick your component


```{r}
library(tidyverse)

# File path
file_path <- "../output/26-rank35-optimization/lambda_gene_0.2/barnacle_factors/time_factors.csv"

# ---- USER INPUT ----
# Pick the component you want to plot (e.g., "Component_5")
selected_component <- "Component_24"
# ---------------------

# Read data
df <- read_csv(file_path)

# Convert to long format
df_long <- df %>%
  pivot_longer(
    cols = starts_with("Component_"),
    names_to = "Component",
    values_to = "Value"
  )

# Check that the chosen component exists
if (!(selected_component %in% unique(df_long$Component))) {
  stop(paste("Component", selected_component, "not found in data!"))
}

# Filter for the selected component
df_sel <- df_long %>% filter(Component == selected_component)

# Plot single component across timepoints
ggplot(df_sel, aes(x = OG_ID, y = Value, group = 1)) +
  geom_line(linewidth = 1.2, color = "steelblue") +
  geom_point(size = 3, color = "firebrick") +
  theme_minimal(base_size = 14) +
  theme(axis.text.x = element_text(angle = 45, hjust = 1)) +
  labs(
    title = paste0(selected_component, " Across Timepoints"),
    x = "Time Point",
    y = "Loading Value"
  )
```



# Genes

```{r}
library(tidyverse)
library(pheatmap)

# Path to your file
file_path <- "../output/26-rank35-optimization/lambda_gene_0.2/barnacle_factors/gene_factors.csv"

# Read data
df <- read_csv(file_path)

# Convert to matrix (remove OG_ID column)
mat <- df %>%
  column_to_rownames(var = "OG_ID") %>%
  as.matrix()


# Optional: scale rows (genes) so colors represent relative loadings per gene
pheatmap(
  mat,
  scale = "row",
  color = colorRampPalette(c("navy", "white", "firebrick3"))(100),
  clustering_method = "ward.D2",
  show_rownames = FALSE,
  main = "Gene Factor Loadings (All Components)"
)
```


```{r}
library(tidyverse)
library(pheatmap)

# Path to file
file_path <- "../output/26-rank35-optimization/lambda_gene_0.2/barnacle_factors/gene_factors.csv"

# Read data
df <- read_csv(file_path)

# Convert to numeric matrix
mat <- df %>%
  column_to_rownames(var = "OG_ID") %>%
  as.matrix()

# Heatmap of actual (unscaled) values
pheatmap(
  mat,
  scale = "none",  # do not scale
  color = colorRampPalette(c("navy", "white", "firebrick3"))(200),
  clustering_method = "ward.D2",
  show_rownames = FALSE,
  main = "Gene Factor Loadings (Actual Values)"
)
```

# Annotation 

```{r fig.width=8, fig.height=20}
library(tidyverse)
library(pheatmap)

# ---- File path ----
file_path <- "../output/26-rank35-optimization/lambda_gene_0.2/top_genes_per_component/goslim_term_counts.csv"  # change to your actual path

# ---- Read data ----
df <- read_csv(file_path)

# Remove the "total" column if present
df <- df %>% select(-total)

# Convert to matrix (terms as row names)
mat <- df %>%
  column_to_rownames(var = "term") %>%
  as.matrix()



top_terms <- df %>%
  mutate(total_count = rowSums(across(starts_with("Component_")))) %>%
  slice_max(total_count, n = 50)

mat_top <- top_terms %>%
  column_to_rownames(var = "term") %>%
  select(-total_count) %>%
  as.matrix()

pheatmap(
  mat_top,
  scale = "row",
  color = colorRampPalette(c("navy", "white", "firebrick3"))(200),
  show_rownames = TRUE,
  main = "Top 25 Terms by Total Count")

# ---- Plot heatmap ----
pheatmap(
  mat,
  scale = "none",  # use actual values
  color = colorRampPalette(c("navy", "white", "firebrick3"))(200),
  clustering_method = "ward.D2",
  show_rownames = TRUE,
  main = "Term Enrichment Across Components"
)



# Apply log10 transformation (adding +1 to avoid log(0))
mat_log <- log10(mat + 1)

# ---- Plot heatmap ----
pheatmap(
  mat_log,
  scale = "none",
  color = colorRampPalette(c("navy", "white", "firebrick3"))(200),
  clustering_method = "ward.D2",
  show_rownames = TRUE,
  main = "Log10-transformed Term Enrichment Across Components"
)


#scale = "row",  # normalize each row (mean=0, sd=1)


# Apply log10 transformation (adding +1 to avoid log(0))
mat_top_log <- log10(mat_top + 1)

# ---- Plot heatmap ----
pheatmap(
  mat_top_log,
  scale = "none",
  color = colorRampPalette(c("navy", "white", "firebrick3"))(200),
  clustering_method = "ward.D2",
  show_rownames = TRUE,
  main = "Log10-transformed Term Enrichment Across Components"
)
```



# User pick


```{r}
library(tidyverse)
library(pheatmap)

# ---- File path ----
file_path <- "../output/26-rank35-optimization/lambda_gene_0.2/top_genes_per_component/goslim_term_counts.csv"  # change to your actual CSV path

# ---- User input ----
# Enter one or more GO terms (exact or partial match)
selected_terms <- c("protein catabolic process", "lipid", "immune system process", "carbohydrate", "antioxidant activity", "mitochondrion", "inflammatory response", "reproductive")  # example

# ---- Options ----
row_normalize <- TRUE   # TRUE for row-normalized (z-score), FALSE for raw
log_transform <- TRUE   # TRUE to apply log10(x+1) before plotting

# ---- Load and prepare data ----
df <- read_csv(file_path)

# Remove total column if present
df <- df %>% select(-any_of("total"))

# Filter by GO term (partial match supported)
df_sel <- df %>%
  filter(if_any(term, ~ str_detect(.x, paste(selected_terms, collapse = "|"))))

if (nrow(df_sel) == 0) {
  stop("⚠️ No matching GO terms found. Check spelling or capitalization.")
}

# Convert to matrix
mat <- df_sel %>%
  column_to_rownames(var = "term") %>%
  as.matrix()

# Optional log-transform
if (log_transform) {
  mat <- log10(mat + 1)
}

# Optional row normalization
if (row_normalize) {
  mat <- t(scale(t(mat)))  # z-score per row
}

# ---- Plot heatmap ----
pheatmap(
  mat,
  scale = "none",
  color = colorRampPalette(c("navy", "white", "firebrick3"))(200),
  clustering_method = "ward.D2",
  show_rownames = TRUE,
  main = paste(
    "GO Term Heatmap —",
    if (row_normalize) "Row-normalized" else "Raw values",
    if (log_transform) "(log10)" else ""
  )
)
```

