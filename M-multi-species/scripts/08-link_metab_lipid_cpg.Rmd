---
title: "Energetic-Epigenetic Linkages"
author: "R. Cunning"
date: "2025-05-24"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(warning=FALSE, message=FALSE, cache = TRUE)
```


```{r}
library(tidyverse)
```

# Import data

```{r colony_metadata}
# colony metadata
colony_md <- read_csv("M-multi-species/data/phys_master_timeseries.csv") %>%
  select(colony = colony_id, species, site) %>%
  distinct(colony, species, site)
```

## Lipidomic data (all 3 species)
```{r data_lipid}
lip_data <- readRDS("M-multi-species/data/lipidomics/lipids.rds")

lip_data <- lip_data %>%
  mutate(logquant = log(nmol.g_plasma.ug_protein+0.007))    #0.007

#hist(lip_data$logquant)

# ① Reshape your data to a wide format first (one row per colony and timepoint):
lip_data_wide <- lip_data %>%
  select(-nmol.g_plasma.ug_protein) %>%
  pivot_wider(names_from = lipid, values_from = logquant)

# ② Define a function to perform PCA and extract coordinates neatly:
run_lip_pca <- function(df) {
  pca_result <- prcomp(df %>% select(where(is.numeric)), scale = TRUE, center = TRUE)
  coords <- bind_cols(df %>% select(sample, colony, timepoint),
                      as_tibble(pca_result$x))
  return(coords)
}

# Apply PCA for each species separately
# no site info in lipid data
pca_results_lip <- lip_data_wide %>%
  group_by(species) %>%
  nest() %>%
  mutate(pca_coords = map(data, run_lip_pca)) %>%
  select(-data) %>%
  unnest(pca_coords) %>%
  ungroup()

pca_results_lip <- pca_results_lip %>%
  # Get PC1-5 only
  select(colony, species, timepoint, matches("^PC[1-5]$"))

# ④ Visualizing trajectories over time (example):
pca_results_lip %>%
  left_join(colony_md) %>%
  ggplot(aes(x = PC1, y = PC2, group = colony)) +
  geom_path(alpha = 0.6) +
  geom_point(aes(color = timepoint), size = 3) +
  facet_grid(species ~ site, scales = "free") +
  labs(title = "Lipid PCA trajectories over time",
       color = "Timepoint") +
  theme_minimal()



###### lip PC changes over time
pc_changes_lip <- pca_results_lip %>%
  # Ensure correct order of timepoints (assuming TP1 < TP2 < TP3 < TP4 ...)
  mutate(time_num = as.numeric(str_extract(timepoint, "\\d+"))) %>%
  arrange(species, colony, time_num) %>%
  group_by(species, colony) %>%
  mutate(next_timepoint = lead(timepoint),
         interval = if_else(!is.na(next_timepoint),
                            paste0(timepoint, "-", next_timepoint),
                            NA_character_)) %>%
  # Calculate the differences in PC scores between subsequent rows
  mutate(across(starts_with("PC"), ~ lead(.) - ., .names = "delta_{col}")) %>%
  ungroup() %>%
  # Keep only rows that have a valid next interval (forward differences)
  filter(!is.na(interval)) %>%
  select(species, colony, interval, starts_with("delta_PC"))



baseline_vs_changes_lip <- pca_results_lip %>%
  #filter(species == "Acropora") %>%
  mutate(time_num = as.numeric(str_extract(timepoint, "\\d+"))) %>%
  arrange(colony, time_num) %>%
  group_by(colony, species) %>%
  group_modify(~ {
    earlier <- .x
    later <- .x

    pc_cols <- grep("^PC", names(earlier), value = TRUE)

    pair_df <- expand_grid(
      idx_earlier = seq_len(nrow(earlier)),
      idx_later = seq_len(nrow(later))
    ) %>%
      filter(idx_later > idx_earlier) %>%
      mutate(
        baseline_tp = earlier$timepoint[idx_earlier],
        next_tp     = later$timepoint[idx_later],
        interval    = paste0(baseline_tp, "-", next_tp)
      )

    # Add baseline and delta PC values manually
    baseline_pcs <- map_dfc(pc_cols, ~ tibble(!!paste0(.x, "_baseline") := earlier[[.x]][pair_df$idx_earlier]))
    delta_pcs    <- map_dfc(pc_cols, ~ tibble(!!paste0("delta_", .x) := later[[.x]][pair_df$idx_later] - earlier[[.x]][pair_df$idx_earlier]))

    bind_cols(pair_df, baseline_pcs, delta_pcs)
  }) %>%
  ungroup() %>%
  select(colony, species, baseline_tp, next_tp, interval, everything(), -idx_earlier, -idx_later)

```

## Metabolomic data (all 3 species)
```{r data_metab}
# data_im ------ generated in M-multi-species/07-metabolomics-analysis.Rmd
data_im <- readRDS("M-multi-species/data/metabolomics/metabolites.rds")

# ① Reshape your data to a wide format first (one row per colony and timepoint):
metab_data_wide <- data_im %>%
  mutate(logquant = log(rel.quant.ug)) %>%
  select(-rel.quant.ug) %>%
  pivot_wider(names_from = compound, values_from = logquant)

colcounts <- metab_data_wide %>%
  count(colony)

# ② Define a function to perform PCA and extract coordinates neatly:
run_metab_pca <- function(df) {
  pca_result <- prcomp(df %>% select(where(is.numeric)), scale = TRUE, center = TRUE)
  coords <- bind_cols(df %>% select(sample, colony, timepoint),
                      as_tibble(pca_result$x))
  return(coords)
}
# 
# acr <- metab_data_wide %>%
#   filter(species == "Porites")
# acr.pca <- prcomp(select(acr, is.numeric), scale = TRUE, center = TRUE)
# biplot(acr.pca)
# out <- summary(acr.pca)$rotation[,1]
# out[order(out)]
# 
# str(acr.pca)
# ?prcomp
# plot(acr.pca)


# ③ Apply PCA separately for each combination of site and species:
pca_results_metab <- metab_data_wide %>%
  group_by(species) %>%
  nest() %>%
  mutate(pca_coords = map(data, run_metab_pca)) %>%
  select(-data) %>%
  unnest(pca_coords) %>%
  ungroup()

pca_results_metab <- pca_results_metab %>%
  # Get PC1-5only
  select(colony, species, timepoint, matches("^PC[1-5]$")) %>%
  left_join(colony_md)


# ④ Visualizing trajectories over time (example):
pca_results_metab %>%
  ggplot(aes(x = PC1, y = PC2, group = colony)) +
  geom_path(alpha = 0.6) +
  geom_point(aes(color = timepoint), size = 3) +
  facet_grid(species ~ site, scales = "free") +
  labs(title = "Metabolite PCA trajectories over time",
       color = "Timepoint") +
  theme_minimal()



###### Metab PC changes over time
pc_changes_metab <- pca_results_metab %>%
  # Ensure correct order of timepoints (assuming TP1 < TP2 < TP3 < TP4 ...)
  mutate(time_num = as.numeric(str_extract(timepoint, "\\d+"))) %>%
  arrange(site, species, colony, time_num) %>%
  group_by(site, species, colony) %>%
  mutate(next_timepoint = lead(timepoint),
         interval = if_else(!is.na(next_timepoint),
                            paste0(timepoint, "-", next_timepoint),
                            NA_character_)) %>%
  # Calculate the differences in PC scores between subsequent rows
  mutate(across(starts_with("PC"), ~ lead(.) - ., .names = "delta_{col}")) %>%
  ungroup() %>%
  # Keep only rows that have a valid next interval (forward differences)
  filter(!is.na(interval)) %>%
  select(site, species, colony, interval, starts_with("delta_PC"))

# Metab Baseline vs. changes
baseline_vs_changes_metab <- pc_changes_metab %>%
  separate(interval, into = c("baseline_tp", "next_tp"), sep = "-") %>%
  left_join(
    pca_results_metab %>% 
      rename_with(~ paste0("baseline_", .), starts_with("PC")),
    by = c("site", "species", "colony", "baseline_tp" = "timepoint")
  ) %>%
  select(site, species, colony, baseline_tp, next_tp, starts_with("delta_"), starts_with("baseline_PC"))


# Recompute baseline and deltas for all forward intervals (Tp1-Tp2, Tp1-Tp3, Tp1-Tp4, etc.)
baseline_vs_changes_metab <- pca_results_metab %>%
  mutate(time_num = as.numeric(str_extract(timepoint, "\\d+"))) %>%
  arrange(colony, time_num) %>%
  group_by(colony, site, species) %>%
  group_modify(~ {
    earlier <- .x
    later <- .x

    pc_cols <- grep("^PC", names(earlier), value = TRUE)

    pair_df <- expand_grid(
      idx_earlier = seq_len(nrow(earlier)),
      idx_later = seq_len(nrow(later))
    ) %>%
      filter(idx_later > idx_earlier) %>%
      mutate(
        baseline_tp = earlier$timepoint[idx_earlier],
        next_tp     = later$timepoint[idx_later],
        interval    = paste0(baseline_tp, "-", next_tp)
      )

    # Add baseline and delta PC values manually
    baseline_pcs <- map_dfc(pc_cols, ~ tibble(!!paste0(.x, "_baseline") := earlier[[.x]][pair_df$idx_earlier]))
    delta_pcs    <- map_dfc(pc_cols, ~ tibble(!!paste0("delta_", .x) := later[[.x]][pair_df$idx_later] - earlier[[.x]][pair_df$idx_earlier]))

    bind_cols(pair_df, baseline_pcs, delta_pcs)
  }) %>%
  ungroup() %>%
  select(colony, site, species, baseline_tp, next_tp, interval, everything(), -idx_earlier, -idx_later)


# test if it worked
# baseline_vs_changes_metab %>% filter(colony == "ACR-139") %>% select(interval, PC1_baseline, delta_PC1)
# pca_results_metab %>% filter(colony == "ACR-139")
```

## Epigenetic data (CpG data)

Acropora
```{r data_cpg_acr}
# D-Apul/22.3-Apul-multiomic-machine-learning-byTP.Rmd
acr_cpg <- read_csv("D-Apul/output/22.5-Apul-multiomic-SR/Apul-filtered-WGBS-CpG-counts.csv")

acr_cpg_wide_by_colony_tp <- acr_cpg %>%
  rename(acr_cpg_id = 1) %>%
  pivot_longer(-acr_cpg_id, names_to = "sample", values_to = "value") %>%
  separate(sample, into = c("colony", "timepoint"), sep = "-TP", remove = FALSE) %>%
  mutate(timepoint = paste0("TP", timepoint)) %>%
  select(colony, timepoint, acr_cpg_id, value) %>%
  pivot_wider(names_from = acr_cpg_id, values_from = value)


# Remove columns with zero standard deviation
acr_cpg_pca_input <- acr_cpg_wide_by_colony_tp %>%
  select(-colony, -timepoint) %>%
  select(where(~ sd(., na.rm = TRUE) > 0))

# Run PCA on acr_cpg values (exclude colony and timepoint columns)
pca_acr_cpg <- prcomp(
  acr_cpg_pca_input,
  scale. = TRUE, center = TRUE
)

# Add PC scores back to sample metadata
# Extract just the identifiers (colony + timepoint) in the correct order
acr_cpg_metadata <- acr_cpg_wide_by_colony_tp %>%
  select(colony, timepoint)

# Create final PCA results with just colony, timepoint, and PC scores
# Keep only PC1 to PC5 from the PCA output
acr_cpg_pca_results <- acr_cpg_metadata %>%
  bind_cols(as_tibble(pca_acr_cpg$x[, 1:5]))

# 1. Extract site and colony info from metabolomic PCA results
colony_site_lookup <- pca_results_metab %>%
  filter(species == "Acropora") %>%
  distinct(colony, site)

# 2. Join site info into acr_cpg PCA results
acr_cpg_pca_results_with_site <- acr_cpg_pca_results %>%
  left_join(colony_site_lookup, by = "colony")

# # 3. Plot PCA trajectories with site info
# acr_cpg_pca_results_with_site %>%
#   ggplot(aes(x = PC1, y = PC2, group = colony)) +
#   geom_path(alpha = 0.6) +
#   geom_point(aes(color = timepoint), size = 3) +
#   facet_grid(~ site, scales = "free") +
#   labs(
#     title = "acr_cpg PCA trajectories over time by site (Acropora only)",
#     color = "Timepoint"
#   ) +
#   theme_minimal()

# Compute PC change intervals by colony
pc_changes_acr_cpg <- acr_cpg_pca_results %>%
  mutate(time_num = as.numeric(str_extract(timepoint, "\\d+"))) %>%
  arrange(colony, time_num) %>%
  group_by(colony) %>%
  mutate(
    next_timepoint = lead(timepoint),
    interval = if_else(!is.na(next_timepoint),
                       paste0(timepoint, "-", next_timepoint),
                       NA_character_)
  ) %>%
  mutate(across(starts_with("PC"), ~ lead(.) - ., .names = "delta_{col}")) %>%
  ungroup() %>%
  filter(!is.na(interval)) %>%
  select(colony, interval, starts_with("delta_"))

# Match each PC change to the baseline PC value
baseline_vs_changes_acr_cpg <- pc_changes_acr_cpg %>%
  separate(interval, into = c("baseline_tp", "next_tp"), sep = "-") %>%
  left_join(
    acr_cpg_pca_results %>%
      rename_with(~ paste0("baseline_", .), starts_with("PC")),
    by = c("colony", "baseline_tp" = "timepoint")
  ) %>%
  select(colony, baseline_tp, next_tp, starts_with("delta_"), starts_with("baseline_PC"))


# # Recompute with all forward time intervals
# baseline_vs_changes_acr_cpg <- acr_cpg_pca_results_with_site %>%
#   mutate(time_num = as.numeric(str_extract(timepoint, "\\d+"))) %>%
#   arrange(colony, time_num) %>%
#   group_by(colony, site) %>%
#   group_modify(~ {
#     earlier <- .x
#     later <- .x
# 
#     pc_cols <- grep("^PC", names(earlier), value = TRUE)
# 
#     pair_df <- expand_grid(
#       idx_earlier = seq_len(nrow(earlier)),
#       idx_later   = seq_len(nrow(later))
#     ) %>%
#       filter(idx_later > idx_earlier) %>%
#       mutate(
#         baseline_tp = earlier$timepoint[idx_earlier],
#         next_tp     = later$timepoint[idx_later],
#         interval    = paste0(baseline_tp, "-", next_tp)
#       )
# 
#     baseline_pcs <- map_dfc(pc_cols, ~ tibble(!!paste0(.x, "_baseline") := earlier[[.x]][pair_df$idx_earlier]))
#     delta_pcs    <- map_dfc(pc_cols, ~ tibble(!!paste0("delta_", .x) := later[[.x]][pair_df$idx_later] - earlier[[.x]][pair_df$idx_earlier]))
# 
#     bind_cols(pair_df, baseline_pcs, delta_pcs)
#   }) %>%
#   ungroup() %>%
#   select(colony, site, baseline_tp, next_tp, interval, everything(), -idx_earlier, -idx_later)


# Recompute with all forward time intervals
baseline_vs_changes_acr_cpg <- acr_cpg_pca_results_with_site %>%
  mutate(time_num = as.numeric(str_extract(timepoint, "\\d+"))) %>%
  arrange(colony, time_num) %>%
  group_by(colony, site) %>%
  group_modify(~ {
    earlier <- .x
    later <- .x

    pc_cols <- grep("^PC", names(earlier), value = TRUE)

    pair_df <- expand_grid(
      idx_earlier = seq_len(nrow(earlier)),
      idx_later   = seq_len(nrow(later))
    ) %>%
      filter(idx_later > idx_earlier) %>%
      mutate(
        baseline_tp = earlier$timepoint[idx_earlier],
        next_tp     = later$timepoint[idx_later],
        interval    = paste0(baseline_tp, "-", next_tp)
      )

    baseline_pcs <- map_dfc(pc_cols, ~ tibble(!!paste0(.x, "_baseline") := earlier[[.x]][pair_df$idx_earlier]))
    delta_pcs    <- map_dfc(pc_cols, ~ tibble(!!paste0("delta_", .x) := later[[.x]][pair_df$idx_later] - earlier[[.x]][pair_df$idx_earlier]))

    bind_cols(pair_df, baseline_pcs, delta_pcs)
  }) %>%
  ungroup() %>%
  select(colony, site, baseline_tp, next_tp, interval, everything(), -idx_earlier, -idx_later)


```

Pocillopora
```{r data_cpg_poc}
# D-Apul/22.3-Apul-multiomic-machine-learning-byTP.Rmd
poc_cpg <- read_csv("F-Ptua/output/05-Ptua-bismark-CG/filtered-WGBS-CpG-counts.csv")

poc_cpg_wide_by_colony_tp <- poc_cpg %>%
  rename(poc_cpg_id = 1) %>%
  pivot_longer(-poc_cpg_id, names_to = "sample", values_to = "value") %>%
  mutate(
    sample = str_extract(sample, "^[^.]+"),  # Get part before the dot
    colony = str_extract(sample, "^.*(?=-TP)"),  # Everything before -TP
    timepoint = str_extract(sample, "TP\\d+")   # Extract TP1, TP2, etc.
  ) %>%
  select(colony, timepoint, poc_cpg_id, value) %>%
  pivot_wider(names_from = poc_cpg_id, values_from = value)

# Run PCA on poc_cpg values (exclude colony and timepoint columns)
pca_poc_cpg <- prcomp(
  poc_cpg_wide_by_colony_tp %>% select(-colony, -timepoint),
  scale. = TRUE, center = TRUE
)

# Add PC scores back to sample metadata
# Extract just the identifiers (colony + timepoint) in the correct order
poc_cpg_metadata <- poc_cpg_wide_by_colony_tp %>%
  select(colony, timepoint)

# Create final PCA results with just colony, timepoint, and PC scores
# Keep only PC1 to PC5 from the PCA output
poc_cpg_pca_results <- poc_cpg_metadata %>%
  bind_cols(as_tibble(pca_poc_cpg$x[, 1:5]))

# 1. Extract site and colony info from metabolomic PCA results
colony_site_lookup <- pca_results_metab %>%
  filter(species == "Pocillopora") %>%
  distinct(colony, site)

# 2. Join site info into poc_cpg PCA results
poc_cpg_pca_results_with_site <- poc_cpg_pca_results %>%
  left_join(colony_site_lookup, by = "colony")

# 3. Plot PCA trajectories with site info
# poc_cpg_pca_results_with_site %>%
#   ggplot(aes(x = PC1, y = PC2, group = colony)) +
#   geom_path(alpha = 0.6) +
#   geom_point(aes(color = timepoint), size = 3) +
#   facet_grid(~ site, scales = "free") +
#   labs(
#     title = "poc_cpg PCA trajectories over time by site (Acropora only)",
#     color = "Timepoint"
#   ) +
#   theme_minimal()

# Compute PC change intervals by colony
pc_changes_poc_cpg <- poc_cpg_pca_results %>%
  mutate(time_num = as.numeric(str_extract(timepoint, "\\d+"))) %>%
  arrange(colony, time_num) %>%
  group_by(colony) %>%
  mutate(
    next_timepoint = lead(timepoint),
    interval = if_else(!is.na(next_timepoint),
                       paste0(timepoint, "-", next_timepoint),
                       NA_character_)
  ) %>%
  mutate(across(starts_with("PC"), ~ lead(.) - ., .names = "delta_{col}")) %>%
  ungroup() %>%
  filter(!is.na(interval)) %>%
  select(colony, interval, starts_with("delta_"))

# Match each PC change to the baseline PC value
baseline_vs_changes_poc_cpg <- pc_changes_poc_cpg %>%
  separate(interval, into = c("baseline_tp", "next_tp"), sep = "-") %>%
  left_join(
    poc_cpg_pca_results %>%
      rename_with(~ paste0("baseline_", .), starts_with("PC")),
    by = c("colony", "baseline_tp" = "timepoint")
  ) %>%
  select(colony, baseline_tp, next_tp, starts_with("delta_"), starts_with("baseline_PC"))


# Recompute with all forward time intervals
baseline_vs_changes_poc_cpg <- poc_cpg_pca_results_with_site %>%
  mutate(time_num = as.numeric(str_extract(timepoint, "\\d+"))) %>%
  arrange(colony, time_num) %>%
  group_by(colony, site) %>%
  group_modify(~ {
    earlier <- .x
    later <- .x

    pc_cols <- grep("^PC", names(earlier), value = TRUE)

    pair_df <- expand_grid(
      idx_earlier = seq_len(nrow(earlier)),
      idx_later   = seq_len(nrow(later))
    ) %>%
      filter(idx_later > idx_earlier) %>%
      mutate(
        baseline_tp = earlier$timepoint[idx_earlier],
        next_tp     = later$timepoint[idx_later],
        interval    = paste0(baseline_tp, "-", next_tp)
      )

    baseline_pcs <- map_dfc(pc_cols, ~ tibble(!!paste0(.x, "_baseline") := earlier[[.x]][pair_df$idx_earlier]))
    delta_pcs    <- map_dfc(pc_cols, ~ tibble(!!paste0("delta_", .x) := later[[.x]][pair_df$idx_later] - earlier[[.x]][pair_df$idx_earlier]))

    bind_cols(pair_df, baseline_pcs, delta_pcs)
  }) %>%
  ungroup() %>%
  select(colony, site, baseline_tp, next_tp, interval, everything(), -idx_earlier, -idx_later)


```

Visualize CpG principal component changes
```{r}
bind_rows(poc_cpg_pca_results_with_site, acr_cpg_pca_results_with_site) %>%
  left_join(colony_md) %>%
  ggplot(aes(x = PC1, y = PC2, group = colony)) +
  geom_path(alpha = 0.6) +
  geom_point(aes(color = timepoint), size = 3) +
  facet_grid(species ~ site, scales = "free") +
  labs(
    title = "CPG PCA trajectories over time by site (Acropora only)",
    color = "Timepoint"
  ) +
  theme_minimal()
```

## Epigenetic machinery gene expression data 
```{r, include = F, eval = F}
epimachine <- read_csv("D-Apul/output/29-Apul-epimachine-exp/Apul-epimachine-expression.csv")

epimachine <- epimachine %>%
  select(gene_id = V1, 13:ncol(.))


# make unique gene_id names
epimachine <- epimachine %>%
  mutate(gene_id = make.unique(gene_id))

# Step 1: Transpose so samples are rows, genes are columns
expr_matrix <- epimachine %>%
  column_to_rownames("gene_id") %>%
  t() %>%
  as.data.frame()

expr_matrix$`H2AW-201`

expr_matrix_filtered <- expr_matrix %>%
  select(where(~ {
    x <- .
    s <- sd(x, na.rm = TRUE)
    is.finite(s) && s > 0
  }))

# Step 2: PCA (centered and scaled)
pca_results <- prcomp(expr_matrix_filtered, center = TRUE, scale. = TRUE)

# Step 3: Get scores (PCA coordinates for each sample)
pca_scores <- as_tibble(pca_results$x, rownames = "sample")
pca_scores <- pca_scores %>%
  mutate(
    timepoint = str_extract(sample, "TP\\d"),
    timepoint = factor(timepoint, levels = c("TP1", "TP2", "TP3", "TP4")),
    colony = str_extract(sample, "ACR-\\d+")
  ) %>%
  arrange(colony, timepoint)

# Step 4: Plot (e.g., PC1 vs PC2)
ggplot(pca_scores, aes(x = PC1, y = PC2, group = colony)) +
  geom_point(aes(color = timepoint), size = 3) +
  geom_path() +
  facet_wrap(~colony) +
  labs(title = "PCA of Gene Expression", x = "PC1", y = "PC2") +
  theme_minimal()


# Baseline and change
pca_results_gene <- pca_scores %>%
  mutate(
    time_num = as.numeric(str_extract(timepoint, "\\d+"))
  ) %>%
  arrange(colony, time_num)

baseline_vs_changes_gene <- pca_results_gene %>%
  group_by(colony) %>%
  group_modify(~ {
    earlier <- .x
    later <- .x

    pc_cols <- grep("^PC", names(earlier), value = TRUE)

    pair_df <- expand_grid(
      idx_earlier = seq_len(nrow(earlier)),
      idx_later = seq_len(nrow(later))
    ) %>%
      filter(idx_later > idx_earlier) %>%
      mutate(
        baseline_tp = earlier$timepoint[idx_earlier],
        next_tp     = later$timepoint[idx_later],
        interval    = paste0(baseline_tp, "-", next_tp)
      )

    # Extract baseline and compute deltas
    baseline_pcs <- map_dfc(pc_cols, ~ tibble(!!paste0(.x, "_baseline") := earlier[[.x]][pair_df$idx_earlier]))
    delta_pcs    <- map_dfc(pc_cols, ~ tibble(!!paste0("delta_", .x) := later[[.x]][pair_df$idx_later] - earlier[[.x]][pair_df$idx_earlier]))

    bind_cols(pair_df, baseline_pcs, delta_pcs)
  }) %>%
  ungroup() %>%
  select(colony, baseline_tp, next_tp, interval, everything(), -idx_earlier, -idx_later)

```


# Combine epigenetic/energetic Principal Component data
```{r combine_pc_data}

# 1. Rename lipid columns (if not already)
baseline_vs_changes_lip_renamed <- baseline_vs_changes_lip %>%
  rename_with(~ paste0(.x, "_lip"), ends_with("_baseline")) %>%
  rename_with(~ paste0(.x, "_lip"), starts_with("delta_PC"))

# 1. Rename metabolomic columns (if not already)
baseline_vs_changes_metab_renamed <- baseline_vs_changes_metab %>%
  rename_with(~ paste0(.x, "_metab"), ends_with("_baseline")) %>%
  rename_with(~ paste0(.x, "_metab"), starts_with("delta_PC"))

# 2. Rename Acr CpG columns (if not already)
baseline_vs_changes_acr_cpg_renamed <- baseline_vs_changes_acr_cpg %>%
  rename_with(~ paste0(.x, "_cpg"), ends_with("_baseline")) %>%
  rename_with(~ paste0(.x, "_cpg"), starts_with("delta_PC"))

# 2. Rename Poc CpG columns (if not already)
baseline_vs_changes_poc_cpg_renamed <- baseline_vs_changes_poc_cpg %>%
  rename_with(~ paste0(.x, "_cpg"), ends_with("_baseline")) %>%
  rename_with(~ paste0(.x, "_cpg"), starts_with("delta_PC"))

baseline_vs_changes_all_cpg_renamed <- bind_rows(
  baseline_vs_changes_acr_cpg_renamed,
  baseline_vs_changes_poc_cpg_renamed
)

# Rename epimachine gene exp data
# baseline_vs_changes_gene_renamed <- baseline_vs_changes_gene %>%
#   rename_with(~ paste0(.x, "_gene"), ends_with("_baseline")) %>%
#   rename_with(~ paste0(.x, "_gene"), starts_with("delta_PC"))


# 3. Join metabolomic, lipidomic, and CpG PCA results
metab_cpg_lip_combined <- baseline_vs_changes_all_cpg_renamed %>%     # All SPP
  left_join(baseline_vs_changes_lip_renamed,            # All SPP
    by = c("colony", "baseline_tp", "next_tp", "interval")
  ) %>%
  left_join(
    baseline_vs_changes_metab_renamed,        
    by = c("colony", "baseline_tp", "next_tp", "interval")
  ) %>%
  # left_join(
  #   baseline_vs_changes_gene_renamed,
  #   by = c("colony", "baseline_tp", "next_tp", "interval")
  # ) %>%
  mutate(interval_label = paste0(baseline_tp, "–", next_tp),
         species = str_sub(colony, 1, 3))
```


```{r, include = F, eval = F}
# Metabolomic PC baseline --> Epigenetic machinery gene exp change

metab_cpg_lip_combined %>%
  filter(!is.na(PC1_baseline_metab)) %>%
  ggplot(aes(x = PC1_baseline_metab, y = delta_PC1_gene)) +
  geom_point(aes(color = species, shape = site.x), size = 3, alpha = 0.7) +
  facet_wrap(species ~ interval_label, scales = "free") +
  geom_smooth(method = "lm", color = "black") +
  ggpubr::stat_cor() +
  labs(
    x = "Baseline Metabolomic PC1",
    y = "Change in Epigenetic Machinery Gene Expression PC1",
    title = "Metabolomic baseline vs. epigenetic change across time intervals"
  ) +
  theme_minimal()
```


# Metabolomic PC baseline --> Epigenetic PC change
```{r}
# METAB vs. CPG
metab_cpg_lip_combined %>%
  filter(!is.na(PC1_baseline_metab)) %>%
  ggplot(aes(x = PC1_baseline_metab, y = delta_PC1_cpg)) +
  geom_point(aes(color = species, shape = site.x), size = 3, alpha = 0.7) +
  facet_wrap(species ~ interval_label, scales = "free") +
  geom_smooth(method = "lm", color = "black") +
  ggpubr::stat_cor() +
  labs(
    x = "Baseline Metabolomic PC1",
    y = "Change in Epigenetic PC1",
    title = "Metabolomic baseline vs. epigenetic change across time intervals"
  ) +
  theme_minimal()
```

# Epigenetic PC baseline --> Metabolomic PC change
```{r}
metab_cpg_lip_combined %>%
  filter(!is.na(PC1_baseline_metab)) %>%
  ggplot(aes(x = PC1_baseline_cpg, y = delta_PC1_metab)) +
  geom_point(aes(color = species, shape = site.x), size = 3, alpha = 0.8) +
  geom_smooth(method = "lm", se = TRUE, color = "black") +
  ggpubr::stat_cor() +
  facet_wrap(species ~ interval_label, scales = "free") +
  labs(
    x = "Baseline Epigenetic PC1",
    y = "Change in Metabolomic PC1",
    title = "Baseline Epigenetic PC1 vs. Metabolomic PC1 Change by Interval"
  ) +
  theme_minimal()
```


# Lipidomic PC baseline --> Epigenetic PC change 
```{r}

# LIPIDS vs. CPG

metab_cpg_lip_combined %>%
  filter(!is.na(PC1_baseline_lip)) %>%
  ggplot(aes(x = PC1_baseline_lip, y = delta_PC1_cpg)) +
  geom_point(aes(color = species, shape = site.x), size = 3, alpha = 0.7) +
  facet_wrap(species ~ interval_label, scales = "free") +
  geom_smooth(method = "lm", color = "black") +
  ggpubr::stat_cor() +
  labs(
    x = "Baseline Lipidomic PC1",
    y = "Change in Epigenetic PC1",
    title = "Lipid baseline vs. epigenetic change across time intervals"
  ) +
  theme_minimal()
```

# Epigenetic PC baseline --> lipidomic PC change
```{r}

metab_cpg_lip_combined %>%
  filter(!is.na(delta_PC1_lip)) %>%
  ggplot(aes(x = PC1_baseline_cpg, y = delta_PC1_lip)) +
  geom_point(aes(color = species, shape = site.x), size = 3, alpha = 0.8) +
  geom_smooth(method = "lm", se = TRUE, color = "black") +
  ggpubr::stat_cor() +
  facet_wrap(species ~ interval_label, scales = "free") +
  labs(
    x = "Baseline Epigenetic PC1",
    y = "Change in Lipidomic PC1",
    title = "Baseline Epigenetic PC1 vs. Lipid PC1 Change by Interval"
  ) +
  theme_minimal()
```


## Compute absolute and net methylation change
### Acropora
```{r}
# Get only the CpG site columns
acr_cpg_cols <- colnames(acr_cpg_wide_by_colony_tp)[!colnames(acr_cpg_wide_by_colony_tp) %in% c("colony", "timepoint")]
poc_cpg_cols <- colnames(poc_cpg_wide_by_colony_tp)[!colnames(poc_cpg_wide_by_colony_tp) %in% c("colony", "timepoint")]

# Compute forward-in-time methylation changes per colony
acr_methylation_change_summary <- acr_cpg_wide_by_colony_tp %>%
  mutate(time_num = as.numeric(str_extract(timepoint, "\\d+"))) %>%
  arrange(colony, time_num) %>%
  group_by(colony) %>%
  group_modify(~ {
    earlier <- .x
    later <- .x

    expand_grid(
      idx_earlier = seq_len(nrow(earlier)),
      idx_later   = seq_len(nrow(later))
    ) %>%
      filter(idx_later > idx_earlier) %>%
      mutate(
        baseline_tp = earlier$timepoint[idx_earlier],
        next_tp     = later$timepoint[idx_later],
        interval    = paste0(baseline_tp, "-", next_tp),
        total_abs_change = map2_dbl(
          idx_earlier, idx_later,
          ~ sum(abs(earlier[.x, acr_cpg_cols] - later[.y, acr_cpg_cols]), na.rm = TRUE)
        ),
        total_net_change = map2_dbl(
          idx_earlier, idx_later,
          ~ sum(later[.y, acr_cpg_cols] - earlier[.x, acr_cpg_cols], na.rm = TRUE)
        )
      )
  }) %>%
  ungroup() %>%
  select(colony, baseline_tp, next_tp, interval, total_abs_change, total_net_change)





# # join to lipidomic data
# acr_res <- acr_methylation_change_summary %>% inner_join(baseline_vs_changes_lip_renamed)
# 
# ggplot(acr_res, aes(x = PC1_baseline_lip, y = total_net_change)) +
#   geom_point() +
#   geom_smooth(method = "lm") +
#   facet_wrap(~interval) +
#   ggpubr::stat_cor()
```

### Pocillopora
```{r}
# Get only the CpG site columns
poc_cpg_cols <- colnames(poc_cpg_wide_by_colony_tp)[!colnames(poc_cpg_wide_by_colony_tp) %in% c("colony", "timepoint")]

# Compute forward-in-time methylation changes per colony
library(dplyr)
library(tidyr)
library(purrr)

poc_methylation_change_summary <- poc_cpg_wide_by_colony_tp %>%
  mutate(time_num = as.numeric(str_extract(timepoint, "\\d+"))) %>%
  arrange(colony, time_num) %>%
  group_by(colony) %>%
  group_modify(~ {
    if (nrow(.x) < 2) return(tibble())  # Skip groups with <2 timepoints

    mat <- as.matrix(.x[, poc_cpg_cols])
    timepoints <- .x$timepoint
    n <- nrow(mat)
    
    idx_pairs <- which(upper.tri(matrix(NA, n, n)), arr.ind = TRUE)
    
    diffs <- mat[idx_pairs[,2], , drop = FALSE] - mat[idx_pairs[,1], , drop = FALSE]
    
    tibble(
      baseline_tp = timepoints[idx_pairs[,1]],
      next_tp     = timepoints[idx_pairs[,2]],
      interval    = paste0(baseline_tp, "-", next_tp),
      total_abs_change = rowSums(abs(diffs), na.rm = TRUE),
      total_net_change = rowSums(diffs, na.rm = TRUE)
    )
  }) %>%
  ungroup() %>%
  select(colony, baseline_tp, next_tp, interval, total_abs_change, total_net_change)



```

## Plot methylation change vs. metabolomic PC
```{r}
# combine methylation change summary across species
all_methylation_change_summary <- bind_rows(
  acr_methylation_change_summary,
  poc_methylation_change_summary)

# join to metabolomic data
metab_methylation_res <- all_methylation_change_summary %>% 
  inner_join(baseline_vs_changes_metab_renamed)

ggplot(metab_methylation_res, aes(x = PC1_baseline_metab, y = total_net_change)) +
  geom_point(aes(color = species, shape = site)) +
  geom_smooth(method = "lm", color = "black") +
  facet_wrap(species~interval, scales = "free") +
  ggpubr::stat_cor() +
    theme_minimal()


# join to lipidomic data
lipid_methylation_res <- all_methylation_change_summary %>% 
  inner_join(baseline_vs_changes_lip_renamed) %>%
  left_join(colony_md)

ggplot(lipid_methylation_res, aes(x = PC1_baseline_lip, y = total_net_change)) +
  geom_point(aes(color = species, shape = site)) +
  geom_smooth(method = "lm", color = "black") +
  facet_wrap(species~interval, scales = "free") +
  ggpubr::stat_cor() +
    theme_minimal()

```


```{r, eval = F, include = F, fig.width = 10}
# Individual metabolites --> epimachine changes

```

# Individual metabolites --> methylation changes
```{r, fig.width = 10}
# Reshape metabolite data to long format (excluding identifiers)
metab_long <- metab_data_wide %>%
  pivot_longer(
    cols = -c(sample, colony, timepoint, species, site),
    names_to = "metabolite",
    values_to = "value"
  )

# Join baseline metabolite value to methylation interval data

# Filter absolute methylation changes if we want to plot that -- there was an outlier...
# all_methylation_change_summary_filtered <- all_methylation_change_summary %>%
#   mutate(species = str_sub(colony, 1, 3)) %>%
#   group_by(species) %>%
#   mutate(
#     q1 = quantile(total_abs_change, 0.25, na.rm = TRUE),
#     q3 = quantile(total_abs_change, 0.75, na.rm = TRUE),
#     iqr = q3 - q1,
#     lower_bound = q1 - 1.5 * iqr,
#     upper_bound = q3 + 1.5 * iqr
#   ) %>%
#   filter(total_abs_change >= lower_bound & total_abs_change <= upper_bound) %>%
#   select(-q1, -q3, -iqr, -lower_bound, -upper_bound) %>%
#   ungroup()

metab_methylation_joined <- all_methylation_change_summary %>%
  inner_join(
    metab_long %>%
      rename(baseline_tp = timepoint, baseline_value = value),
    by = c("colony", "baseline_tp")
  )

# Compute correlation for each metabolite × interval
metab_corrs <- metab_methylation_joined %>%
  group_by(metabolite, interval) %>%
  summarise(
    cor_test = list(cor.test(baseline_value, total_net_change)),
    .groups = "drop"
  ) %>%
  mutate(
    tidied = map(cor_test, broom::tidy)
  ) %>%
  unnest(tidied) %>%
  select(metabolite, interval, estimate, p.value)

# Optional: classify significant & strong correlations
metab_corrs <- metab_corrs %>%
  mutate(
    sig = p.value < 0.05,
    strong = abs(estimate) > 0.5
  )

top10 <- metab_corrs %>% 
  #filter(interval %in% c("TP1-TP2", "TP3-TP4")) %>%
  arrange(-abs(estimate), p.value)

# Count how many intervals each metabolite had strong and significant correlations
metab_summary <- metab_corrs %>%
  group_by(metabolite) %>%
  summarise(
    n_intervals = n(),
    n_strong_sig = sum(sig & strong),
    avg_cor = mean(abs(estimate)),
    .groups = "drop"
  ) %>%
  arrange(desc(n_strong_sig), desc(avg_cor))


# Plot individual metabolite vs. methylation changes
plot_metab_vs_methylation_change <- function(metab_data_wide, methylation_change_summary, variable_name) {
  
  # Get variable + colony + timepoint
  metab_var <- metab_data_wide %>%
    select(colony, timepoint, species, !!sym(variable_name))
  
  # Join baseline value of variable to methylation change summary
  joined <- methylation_change_summary %>%
    inner_join(
      metab_var %>%
        rename(baseline_tp = timepoint, baseline_value = !!sym(variable_name)),
      by = c("colony", "baseline_tp")
    ) %>%
    left_join(colony_md)
  
  # Plot baseline value vs. methylation change
  ggplot(joined, aes(x = baseline_value, y = total_net_change)) +
    geom_point(aes(color = species, shape = site), size = 3, alpha = 0.7) +
    geom_smooth(method = "lm", se = TRUE, color = "black") +
    facet_wrap(species~interval, scales = "free", nrow = 2) +
    labs(
      x = paste("Baseline", variable_name),
      y = "Net Change in Methylation",
      title = paste("Baseline", variable_name, "vs. Methylation Change")
    ) +
    ggpubr::stat_cor(method = "pearson", label.x.npc = "left", label.y.npc = "top") +
    theme_minimal()
}



# Plot top 10
for (i in 1:10) {
  p <- plot_metab_vs_methylation_change(metab_data_wide = metab_data_wide,
                                 methylation_change_summary = all_methylation_change_summary,
                                 variable_name = metab_summary$metabolite[i])
  print(p)
}
```

# Are individual lipids predictive of future methylation changes?

```{r, fig.width = 10}
# Full lipid correlation analysis and plotting
# 1. Reshape lipid data to long format
lip_long <- lip_data_wide %>%
  left_join(colony_md) %>%
  pivot_longer(
    cols = -c(sample, colony, timepoint, species, site, type),
    names_to = "lipid",
    values_to = "value"
  )

# 2. Join baseline lipid value to methylation interval data
lip_methylation_joined <- all_methylation_change_summary %>%
  inner_join(
    lip_long %>%
      rename(baseline_tp = timepoint, baseline_value = value),
    by = c("colony", "baseline_tp")
  )

# 3. Compute correlation for each lipid × interval
lip_corrs <- lip_methylation_joined %>%
  group_by(species, lipid, interval) %>%
  summarise(
    cor_test = list(cor.test(baseline_value, total_net_change)),
    .groups = "drop"
  ) %>%
  mutate(tidied = map(cor_test, broom::tidy)) %>%
  unnest(tidied) %>%
  select(species, lipid, interval, estimate, p.value) %>%
  mutate(
    sig = p.value < 0.05,
    strong = abs(estimate) > 0.5
  )

# 4. Summarize lipids by frequency of strong/significant correlations
lip_summary <- lip_corrs %>%
  group_by(lipid) %>%
  summarise(
    n_intervals = n(),
    n_strong_sig = sum(sig & strong),
    avg_cor = mean(abs(estimate)),
    .groups = "drop"
  ) %>%
  arrange(desc(n_strong_sig), desc(avg_cor))

# 5. Define plot function for individual lipids
plot_lipid_vs_methylation_change <- function(lip_data_wide, methylation_change_summary, variable_name) {
  lip_var <- lip_data_wide %>%
    select(colony, timepoint, species, !!sym(variable_name))
  
  joined <- methylation_change_summary %>%
    inner_join(
      lip_var %>%
        rename(baseline_tp = timepoint, baseline_value = !!sym(variable_name)),
      by = c("colony", "baseline_tp")
    ) %>%
    left_join(colony_md)
  
  ggplot(joined, aes(x = baseline_value, y = total_abs_change)) +
    geom_point(aes(color = species, shape = site), size = 3, alpha = 0.7) +
    geom_smooth(method = "lm", se = TRUE, color = "black") +
    facet_wrap(species ~ interval, scales = "free", nrow = 2) +
    labs(
      x = paste("Baseline", variable_name),
      y = "Net Change in Methylation",
      title = paste("Baseline", variable_name, "vs. Methylation Change")
    ) +
    ggpubr::stat_cor(method = "pearson", label.x.npc = "left", label.y.npc = "top") +
    theme_minimal()
}

# 6. Plot top 10 lipids
for (i in 1:10) {
  p <- plot_lipid_vs_methylation_change(
    lip_data_wide = lip_data_wide,
    methylation_change_summary = all_methylation_change_summary,
    variable_name = lip_summary$lipid[i]
  )
  print(p)
}

```




