---
title: "Energetic-Epigenetic Linkages"
author: "R. Cunning"
date: "2025-05-24"
output:
  html_document:
    # toc: true
    # toc_float: true
    # number_sections: true   # optional
    # theme: flatly            # optional, or try cosmo, journal, etc.
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, warning=FALSE, message=FALSE, cache = FALSE)
knitr::opts_chunk$set(fig.width = 8)  # Set global figure width (in inches)
```


```{r libraries}
library(tidyverse)
library(data.table)
```

# Import data

```{r colony_metadata}
# colony metadata
colony_md <- read_csv("M-multi-species/data/phys_master_timeseries.csv") %>%
  select(colony = colony_id, species, site) %>%
  distinct(colony, species, site)
```

## Lipidomic data (all 3 species)
```{r data_lipid}
lip_data <- readRDS("M-multi-species/data/lipidomics/lipids.rds")

lip_data <- lip_data %>%
  mutate(logquant = log(nmol.g_plasma.ug_protein+0.007))    #0.007

#hist(lip_data$logquant)

# ① Reshape your data to a wide format first (one row per colony and timepoint):
lip_data_wide <- lip_data %>%
  select(-nmol.g_plasma.ug_protein) %>%
  pivot_wider(names_from = lipid, values_from = logquant)

# ② Define a function to perform PCA and extract coordinates neatly:
run_lip_pca <- function(df) {
  pca_result <- prcomp(df %>% select(where(is.numeric)), scale = TRUE, center = TRUE)
  coords <- bind_cols(df %>% select(sample, colony, timepoint),
                      as_tibble(pca_result$x))
  return(coords)
}

# Apply PCA for each species separately
# no site info in lipid data
pca_results_lip <- lip_data_wide %>%
  group_by(species) %>%
  nest() %>%
  mutate(pca_coords = map(data, run_lip_pca)) %>%
  select(-data) %>%
  unnest(pca_coords) %>%
  ungroup()

pca_results_lip <- pca_results_lip %>%
  # Get PC1-5 only
  select(colony, species, timepoint, matches("^PC[1-5]$"))

# ④ Visualizing trajectories over time (example):
pca_results_lip %>%
  left_join(colony_md) %>%
  ggplot(aes(x = PC1, y = PC2, group = colony)) +
  geom_path(alpha = 0.6) +
  geom_point(aes(color = timepoint), size = 3) +
  facet_grid(site ~ species, scales = "free") +
  labs(title = "Lipid PCA trajectories over time",
       color = "Timepoint") +
  theme_minimal()



###### lip PC changes over time
pc_changes_lip <- pca_results_lip %>%
  # Ensure correct order of timepoints (assuming TP1 < TP2 < TP3 < TP4 ...)
  mutate(time_num = as.numeric(str_extract(timepoint, "\\d+"))) %>%
  arrange(species, colony, time_num) %>%
  group_by(species, colony) %>%
  mutate(next_timepoint = lead(timepoint),
         interval = if_else(!is.na(next_timepoint),
                            paste0(timepoint, "-", next_timepoint),
                            NA_character_)) %>%
  # Calculate the differences in PC scores between subsequent rows
  mutate(across(starts_with("PC"), ~ lead(.) - ., .names = "delta_{col}")) %>%
  ungroup() %>%
  # Keep only rows that have a valid next interval (forward differences)
  filter(!is.na(interval)) %>%
  select(species, colony, interval, starts_with("delta_PC"))



baseline_vs_changes_lip <- pca_results_lip %>%
  #filter(species == "Acropora") %>%
  mutate(time_num = as.numeric(str_extract(timepoint, "\\d+"))) %>%
  arrange(colony, time_num) %>%
  group_by(colony, species) %>%
  group_modify(~ {
    earlier <- .x
    later <- .x

    pc_cols <- grep("^PC", names(earlier), value = TRUE)

    pair_df <- expand_grid(
      idx_earlier = seq_len(nrow(earlier)),
      idx_later = seq_len(nrow(later))
    ) %>%
      filter(idx_later > idx_earlier) %>%
      mutate(
        baseline_tp = earlier$timepoint[idx_earlier],
        next_tp     = later$timepoint[idx_later],
        interval    = paste0(baseline_tp, "-", next_tp)
      )

    # Add baseline and delta PC values manually
    baseline_pcs <- map_dfc(pc_cols, ~ tibble(!!paste0(.x, "_baseline") := earlier[[.x]][pair_df$idx_earlier]))
    delta_pcs    <- map_dfc(pc_cols, ~ tibble(!!paste0("delta_", .x) := later[[.x]][pair_df$idx_later] - earlier[[.x]][pair_df$idx_earlier]))

    bind_cols(pair_df, baseline_pcs, delta_pcs)
  }) %>%
  ungroup() %>%
  select(colony, species, baseline_tp, next_tp, interval, everything(), -idx_earlier, -idx_later)

# Class lipid composition
lipid_comp <- lip_data %>%
  select(-type) %>%
  # Extract lipid class prefix
  mutate(class = sub("^(\\D+) .*", "\\1", lipid)) %>%
  
  # Calculate total lipid concentration per sample
  group_by(sample, species, colony, timepoint) %>%
  mutate(total_lipid_concentration = sum(nmol.g_plasma.ug_protein, na.rm = TRUE)) %>%
  
  # Calculate percent composition per lipid
  mutate(percent_lipid = (nmol.g_plasma.ug_protein / total_lipid_concentration) * 100) %>%
  
  # Calculate total class concentration and class-level percent composition
  group_by(sample, species, colony, timepoint, class) %>%
  mutate(total_class_concentration = sum(nmol.g_plasma.ug_protein, na.rm = TRUE),
         percent_class = (total_class_concentration / total_lipid_concentration) * 100) %>%
  
  ungroup() %>%
  select(sample, species, colony, timepoint, lipid, class,
         nmol.g_plasma.ug_protein, total_lipid_concentration,
         total_class_concentration, percent_lipid, percent_class)


# lipid_comp %>%
#   filter(colony == "ACR-229", timepoint == "TP4") %>%
#   summarize(tt = sum(percent_class))
```

## Metabolomic data (all 3 species)
```{r data_metab}
# data_im ------ generated in M-multi-species/07-metabolomics-analysis.Rmd
data_im <- readRDS("M-multi-species/data/metabolomics/metabolites.rds")

# ① Reshape your data to a wide format first (one row per colony and timepoint):
metab_data_wide <- data_im %>%
  mutate(logquant = log(rel.quant.ug)) %>%
  select(-rel.quant.ug) %>%
  pivot_wider(names_from = compound, values_from = logquant)

colcounts <- metab_data_wide %>%
  count(colony)

# ② Define a function to perform PCA and extract coordinates neatly:
run_metab_pca <- function(df) {
  pca_result <- prcomp(df %>% select(where(is.numeric)), scale = TRUE, center = TRUE)
  coords <- bind_cols(df %>% select(sample, colony, timepoint),
                      as_tibble(pca_result$x))
  return(coords)
}
# 
# acr <- metab_data_wide %>%
#   filter(species == "Porites")
# acr.pca <- prcomp(select(acr, is.numeric), scale = TRUE, center = TRUE)
# biplot(acr.pca)
# out <- summary(acr.pca)$rotation[,1]
# out[order(out)]
# 
# str(acr.pca)
# ?prcomp
# plot(acr.pca)


# ③ Apply PCA separately for each combination of site and species:
pca_results_metab <- metab_data_wide %>%
  group_by(species) %>%
  nest() %>%
  mutate(pca_coords = map(data, run_metab_pca)) %>%
  select(-data) %>%
  unnest(pca_coords) %>%
  ungroup()

pca_results_metab <- pca_results_metab %>%
  # Get PC1-5only
  select(colony, species, timepoint, matches("^PC[1-5]$")) %>%
  left_join(colony_md)


# ④ Visualizing trajectories over time (example):
pca_results_metab %>%
  ggplot(aes(x = PC1, y = PC2, group = colony)) +
  geom_path(alpha = 0.6) +
  geom_point(aes(color = timepoint), size = 3) +
  facet_grid(site ~ species, scales = "free") +
  labs(title = "Metabolite PCA trajectories over time",
       color = "Timepoint") +
  theme_minimal()



###### Metab PC changes over time
pc_changes_metab <- pca_results_metab %>%
  # Ensure correct order of timepoints (assuming TP1 < TP2 < TP3 < TP4 ...)
  mutate(time_num = as.numeric(str_extract(timepoint, "\\d+"))) %>%
  arrange(site, species, colony, time_num) %>%
  group_by(site, species, colony) %>%
  mutate(next_timepoint = lead(timepoint),
         interval = if_else(!is.na(next_timepoint),
                            paste0(timepoint, "-", next_timepoint),
                            NA_character_)) %>%
  # Calculate the differences in PC scores between subsequent rows
  mutate(across(starts_with("PC"), ~ lead(.) - ., .names = "delta_{col}")) %>%
  ungroup() %>%
  # Keep only rows that have a valid next interval (forward differences)
  filter(!is.na(interval)) %>%
  select(site, species, colony, interval, starts_with("delta_PC"))

# Metab Baseline vs. changes
baseline_vs_changes_metab <- pc_changes_metab %>%
  separate(interval, into = c("baseline_tp", "next_tp"), sep = "-") %>%
  left_join(
    pca_results_metab %>% 
      rename_with(~ paste0("baseline_", .), starts_with("PC")),
    by = c("site", "species", "colony", "baseline_tp" = "timepoint")
  ) %>%
  select(site, species, colony, baseline_tp, next_tp, starts_with("delta_"), starts_with("baseline_PC"))


# Recompute baseline and deltas for all forward intervals (Tp1-Tp2, Tp1-Tp3, Tp1-Tp4, etc.)
baseline_vs_changes_metab <- pca_results_metab %>%
  mutate(time_num = as.numeric(str_extract(timepoint, "\\d+"))) %>%
  arrange(colony, time_num) %>%
  group_by(colony, site, species) %>%
  group_modify(~ {
    earlier <- .x
    later <- .x

    pc_cols <- grep("^PC", names(earlier), value = TRUE)

    pair_df <- expand_grid(
      idx_earlier = seq_len(nrow(earlier)),
      idx_later = seq_len(nrow(later))
    ) %>%
      filter(idx_later > idx_earlier) %>%
      mutate(
        baseline_tp = earlier$timepoint[idx_earlier],
        next_tp     = later$timepoint[idx_later],
        interval    = paste0(baseline_tp, "-", next_tp)
      )

    # Add baseline and delta PC values manually
    baseline_pcs <- map_dfc(pc_cols, ~ tibble(!!paste0(.x, "_baseline") := earlier[[.x]][pair_df$idx_earlier]))
    delta_pcs    <- map_dfc(pc_cols, ~ tibble(!!paste0("delta_", .x) := later[[.x]][pair_df$idx_later] - earlier[[.x]][pair_df$idx_earlier]))

    bind_cols(pair_df, baseline_pcs, delta_pcs)
  }) %>%
  ungroup() %>%
  select(colony, site, species, baseline_tp, next_tp, interval, everything(), -idx_earlier, -idx_later)


# test if it worked
# baseline_vs_changes_metab %>% filter(colony == "ACR-139") %>% select(interval, PC1_baseline, delta_PC1)
# pca_results_metab %>% filter(colony == "ACR-139")
```

## Methylation data (CpG data)

Acropora
```{r data_cpg_acr}
# D-Apul/22.3-Apul-multiomic-machine-learning-byTP.Rmd
acr_cpg <- read_csv("D-Apul/output/22.5-Apul-multiomic-SR/Apul-filtered-WGBS-CpG-counts.csv")

# acr_cpg_wide_by_colony_tp <- acr_cpg %>%
#   rename(acr_cpg_id = 1) %>%
#   pivot_longer(-acr_cpg_id, names_to = "sample", values_to = "value") %>%
#   separate(sample, into = c("colony", "timepoint"), sep = "-TP", remove = FALSE) %>%
#   mutate(timepoint = paste0("TP", timepoint)) %>%
#   select(colony, timepoint, acr_cpg_id, value) %>%
#   pivot_wider(names_from = acr_cpg_id, values_from = value)
# 


# Convert to data.table
dt <- as.data.table(acr_cpg)
setnames(dt, 1, "acr_cpg_id")  # Rename first column
# Melt (faster pivot_longer)
dt_long <- melt(dt, id.vars = "acr_cpg_id", variable.name = "sample", value.name = "value")
# Extract colony and timepoint using fast string regex
dt_long[, c("colony", "timepoint") := tstrsplit(sample, "-TP", fixed = TRUE)]
dt_long[, timepoint := paste0("TP", timepoint)]
# Recast to wide form (colony/timepoint rows × acr_cpg_id columns)
acr_cpg_wide_by_colony_tp <- dcast(
  dt_long, colony + timepoint ~ acr_cpg_id, value.var = "value") %>%
  as_tibble(.)


# Remove columns with zero standard deviation
acr_cpg_pca_input <- acr_cpg_wide_by_colony_tp %>%
  select(-colony, -timepoint) %>%
  select(where(~ sd(., na.rm = TRUE) > 0))

# Run PCA on acr_cpg values (exclude colony and timepoint columns)
pca_acr_cpg <- prcomp(
  acr_cpg_pca_input,
  scale. = TRUE, center = TRUE
)

# Add PC scores back to sample metadata
# Extract just the identifiers (colony + timepoint) in the correct order
acr_cpg_metadata <- acr_cpg_wide_by_colony_tp %>%
  select(colony, timepoint)

# Create final PCA results with just colony, timepoint, and PC scores
# Keep only PC1 to PC5 from the PCA output
acr_cpg_pca_results <- acr_cpg_metadata %>%
  bind_cols(as_tibble(pca_acr_cpg$x[, 1:5]))

# 1. Extract site and colony info from metabolomic PCA results
colony_site_lookup <- pca_results_metab %>%
  filter(species == "Acropora") %>%
  distinct(colony, site)

# 2. Join site info into acr_cpg PCA results
acr_cpg_pca_results_with_site <- acr_cpg_pca_results %>%
  left_join(colony_site_lookup, by = "colony")


# # Compute PC change intervals by colony
# pc_changes_acr_cpg <- acr_cpg_pca_results %>%
#   mutate(time_num = as.numeric(str_extract(timepoint, "\\d+"))) %>%
#   arrange(colony, time_num) %>%
#   group_by(colony) %>%
#   mutate(
#     next_timepoint = lead(timepoint),
#     interval = if_else(!is.na(next_timepoint),
#                        paste0(timepoint, "-", next_timepoint),
#                        NA_character_)
#   ) %>%
#   mutate(across(starts_with("PC"), ~ lead(.) - ., .names = "delta_{col}")) %>%
#   ungroup() %>%
#   filter(!is.na(interval)) %>%
#   select(colony, interval, starts_with("delta_"))
# 
# # Match each PC change to the baseline PC value
# baseline_vs_changes_acr_cpg <- pc_changes_acr_cpg %>%
#   separate(interval, into = c("baseline_tp", "next_tp"), sep = "-") %>%
#   left_join(
#     acr_cpg_pca_results %>%
#       rename_with(~ paste0("baseline_", .), starts_with("PC")),
#     by = c("colony", "baseline_tp" = "timepoint")
#   ) %>%
#   select(colony, baseline_tp, next_tp, starts_with("delta_"), starts_with("baseline_PC"))


# # Recompute with all forward time intervals
# baseline_vs_changes_acr_cpg <- acr_cpg_pca_results_with_site %>%
#   mutate(time_num = as.numeric(str_extract(timepoint, "\\d+"))) %>%
#   arrange(colony, time_num) %>%
#   group_by(colony, site) %>%
#   group_modify(~ {
#     earlier <- .x
#     later <- .x
# 
#     pc_cols <- grep("^PC", names(earlier), value = TRUE)
# 
#     pair_df <- expand_grid(
#       idx_earlier = seq_len(nrow(earlier)),
#       idx_later   = seq_len(nrow(later))
#     ) %>%
#       filter(idx_later > idx_earlier) %>%
#       mutate(
#         baseline_tp = earlier$timepoint[idx_earlier],
#         next_tp     = later$timepoint[idx_later],
#         interval    = paste0(baseline_tp, "-", next_tp)
#       )
# 
#     baseline_pcs <- map_dfc(pc_cols, ~ tibble(!!paste0(.x, "_baseline") := earlier[[.x]][pair_df$idx_earlier]))
#     delta_pcs    <- map_dfc(pc_cols, ~ tibble(!!paste0("delta_", .x) := later[[.x]][pair_df$idx_later] - earlier[[.x]][pair_df$idx_earlier]))
# 
#     bind_cols(pair_df, baseline_pcs, delta_pcs)
#   }) %>%
#   ungroup() %>%
#   select(colony, site, baseline_tp, next_tp, interval, everything(), -idx_earlier, -idx_later)


# Recompute with all forward time intervals
baseline_vs_changes_acr_cpg <- acr_cpg_pca_results_with_site %>%
  mutate(time_num = as.numeric(str_extract(timepoint, "\\d+"))) %>%
  arrange(colony, time_num) %>%
  group_by(colony, site) %>%
  group_modify(~ {
    earlier <- .x
    later <- .x

    pc_cols <- grep("^PC", names(earlier), value = TRUE)

    pair_df <- expand_grid(
      idx_earlier = seq_len(nrow(earlier)),
      idx_later   = seq_len(nrow(later))
    ) %>%
      filter(idx_later > idx_earlier) %>%
      mutate(
        baseline_tp = earlier$timepoint[idx_earlier],
        next_tp     = later$timepoint[idx_later],
        interval    = paste0(baseline_tp, "-", next_tp)
      )

    baseline_pcs <- map_dfc(pc_cols, ~ tibble(!!paste0(.x, "_baseline") := earlier[[.x]][pair_df$idx_earlier]))
    delta_pcs    <- map_dfc(pc_cols, ~ tibble(!!paste0("delta_", .x) := later[[.x]][pair_df$idx_later] - earlier[[.x]][pair_df$idx_earlier]))

    bind_cols(pair_df, baseline_pcs, delta_pcs)
  }) %>%
  ungroup() %>%
  select(colony, site, baseline_tp, next_tp, interval, everything(), -idx_earlier, -idx_later)


```

Pocillopora
```{r data_cpg_poc}
# D-Apul/22.3-Apul-multiomic-machine-learning-byTP.Rmd
poc_cpg <- read_csv("F-Ptua/output/05-Ptua-bismark-CG/filtered-WGBS-CpG-counts.csv")

poc_cpg_wide_by_colony_tp <- poc_cpg %>%
  rename(poc_cpg_id = 1) %>%
  pivot_longer(-poc_cpg_id, names_to = "sample", values_to = "value") %>%
  mutate(
    sample = str_extract(sample, "^[^.]+"),  # Get part before the dot
    colony = str_extract(sample, "^.*(?=-TP)"),  # Everything before -TP
    timepoint = str_extract(sample, "TP\\d+")   # Extract TP1, TP2, etc.
  ) %>%
  select(colony, timepoint, poc_cpg_id, value) %>%
  pivot_wider(names_from = poc_cpg_id, values_from = value)

# Run PCA on poc_cpg values (exclude colony and timepoint columns)
pca_poc_cpg <- prcomp(
  poc_cpg_wide_by_colony_tp %>% select(-colony, -timepoint),
  scale. = TRUE, center = TRUE
)

# Add PC scores back to sample metadata
# Extract just the identifiers (colony + timepoint) in the correct order
poc_cpg_metadata <- poc_cpg_wide_by_colony_tp %>%
  select(colony, timepoint)

# Create final PCA results with just colony, timepoint, and PC scores
# Keep only PC1 to PC5 from the PCA output
poc_cpg_pca_results <- poc_cpg_metadata %>%
  bind_cols(as_tibble(pca_poc_cpg$x[, 1:5]))

# 1. Extract site and colony info from metabolomic PCA results
colony_site_lookup <- pca_results_metab %>%
  filter(species == "Pocillopora") %>%
  distinct(colony, site)

# 2. Join site info into poc_cpg PCA results
poc_cpg_pca_results_with_site <- poc_cpg_pca_results %>%
  left_join(colony_site_lookup, by = "colony")

# 3. Plot PCA trajectories with site info
# poc_cpg_pca_results_with_site %>%
#   ggplot(aes(x = PC1, y = PC2, group = colony)) +
#   geom_path(alpha = 0.6) +
#   geom_point(aes(color = timepoint), size = 3) +
#   facet_grid(~ site, scales = "free") +
#   labs(
#     title = "poc_cpg PCA trajectories over time by site (Acropora only)",
#     color = "Timepoint"
#   ) +
#   theme_minimal()

# Compute PC change intervals by colony
pc_changes_poc_cpg <- poc_cpg_pca_results %>%
  mutate(time_num = as.numeric(str_extract(timepoint, "\\d+"))) %>%
  arrange(colony, time_num) %>%
  group_by(colony) %>%
  mutate(
    next_timepoint = lead(timepoint),
    interval = if_else(!is.na(next_timepoint),
                       paste0(timepoint, "-", next_timepoint),
                       NA_character_)
  ) %>%
  mutate(across(starts_with("PC"), ~ lead(.) - ., .names = "delta_{col}")) %>%
  ungroup() %>%
  filter(!is.na(interval)) %>%
  select(colony, interval, starts_with("delta_"))

# Match each PC change to the baseline PC value
baseline_vs_changes_poc_cpg <- pc_changes_poc_cpg %>%
  separate(interval, into = c("baseline_tp", "next_tp"), sep = "-") %>%
  left_join(
    poc_cpg_pca_results %>%
      rename_with(~ paste0("baseline_", .), starts_with("PC")),
    by = c("colony", "baseline_tp" = "timepoint")
  ) %>%
  select(colony, baseline_tp, next_tp, starts_with("delta_"), starts_with("baseline_PC"))


# Recompute with all forward time intervals
baseline_vs_changes_poc_cpg <- poc_cpg_pca_results_with_site %>%
  mutate(time_num = as.numeric(str_extract(timepoint, "\\d+"))) %>%
  arrange(colony, time_num) %>%
  group_by(colony, site) %>%
  group_modify(~ {
    earlier <- .x
    later <- .x

    pc_cols <- grep("^PC", names(earlier), value = TRUE)

    pair_df <- expand_grid(
      idx_earlier = seq_len(nrow(earlier)),
      idx_later   = seq_len(nrow(later))
    ) %>%
      filter(idx_later > idx_earlier) %>%
      mutate(
        baseline_tp = earlier$timepoint[idx_earlier],
        next_tp     = later$timepoint[idx_later],
        interval    = paste0(baseline_tp, "-", next_tp)
      )

    baseline_pcs <- map_dfc(pc_cols, ~ tibble(!!paste0(.x, "_baseline") := earlier[[.x]][pair_df$idx_earlier]))
    delta_pcs    <- map_dfc(pc_cols, ~ tibble(!!paste0("delta_", .x) := later[[.x]][pair_df$idx_later] - earlier[[.x]][pair_df$idx_earlier]))

    bind_cols(pair_df, baseline_pcs, delta_pcs)
  }) %>%
  ungroup() %>%
  select(colony, site, baseline_tp, next_tp, interval, everything(), -idx_earlier, -idx_later)


```

Visualize CpG principal component changes
```{r cpg_viz_pca}
bind_rows(poc_cpg_pca_results_with_site, acr_cpg_pca_results_with_site) %>%
  left_join(colony_md) %>%
  ggplot(aes(x = PC1, y = PC2, group = colony)) +
  geom_path(alpha = 0.6) +
  geom_point(aes(color = timepoint), size = 3) +
  facet_grid(species ~ site, scales = "free") +
  labs(
    title = "CPG PCA trajectories over time by site (Acropora only)",
    color = "Timepoint"
  ) +
  theme_minimal()
```

## Expression of epigenetic machinery genes 
```{r data_epimachine}
epimachine <- read_csv("D-Apul/output/29-Apul-epimachine-exp/Apul-epimachine-expression.csv")

epimachine <- epimachine %>%
  select(gene_id = V1, 13:ncol(.))


# make unique gene_id names
epimachine <- epimachine %>%
  mutate(gene_id = make.unique(gene_id))

# Long format
epimachine_long <- epimachine %>%
  pivot_longer(-gene_id, names_to = "sample", values_to = "gene_count") %>%
  separate(sample, into = c("colony", "timepoint_num"), sep = "-TP", remove = FALSE) %>%
  mutate(timepoint = paste0("TP", timepoint_num),
         logcount = log(gene_count)) 



# # PLOT
# # Select top 20 most variable genes
# top_genes <- epimachine %>%
#   rowwise() %>%
#   mutate(var = var(c_across(-gene_id), na.rm = TRUE)) %>%
#   ungroup() %>%
#   slice_max(var, n = 20) %>%
#   pull(gene_id)
# 
# # Plot histograms for those 20 genes
# epimachine %>%
#   filter(gene_id %in% top_genes) %>%
#   pivot_longer(-gene_id, names_to = "sample", values_to = "gene_count") %>%
#   ggplot(aes(x = gene_count)) +
#   geom_histogram(bins = 30, fill = "steelblue", color = "white") +
#   facet_wrap(~ gene_id, scales = "free_y") +
#   labs(
#     title = "Gene Count Distributions (Top 20 Most Variable Genes)",
#     x = "Gene Count",
#     y = "Frequency"
#   ) +
#   scale_x_log10() +
#   theme_minimal(base_size = 10)


```

## Combine Principal Components of lipidomic, metabolomic, and methylation data
```{r combine_pc_data}

# 1. Rename lipid columns (if not already)
baseline_vs_changes_lip_renamed <- baseline_vs_changes_lip %>%
  rename_with(~ paste0(.x, "_lip"), ends_with("_baseline")) %>%
  rename_with(~ paste0(.x, "_lip"), starts_with("delta_PC"))

# 1. Rename metabolomic columns (if not already)
baseline_vs_changes_metab_renamed <- baseline_vs_changes_metab %>%
  rename_with(~ paste0(.x, "_metab"), ends_with("_baseline")) %>%
  rename_with(~ paste0(.x, "_metab"), starts_with("delta_PC"))

# 2. Rename Acr CpG columns (if not already)
baseline_vs_changes_acr_cpg_renamed <- baseline_vs_changes_acr_cpg %>%
  rename_with(~ paste0(.x, "_cpg"), ends_with("_baseline")) %>%
  rename_with(~ paste0(.x, "_cpg"), starts_with("delta_PC"))

# 2. Rename Poc CpG columns (if not already)
baseline_vs_changes_poc_cpg_renamed <- baseline_vs_changes_poc_cpg %>%
  rename_with(~ paste0(.x, "_cpg"), ends_with("_baseline")) %>%
  rename_with(~ paste0(.x, "_cpg"), starts_with("delta_PC"))

baseline_vs_changes_all_cpg_renamed <- bind_rows(
  baseline_vs_changes_acr_cpg_renamed,
  baseline_vs_changes_poc_cpg_renamed
)

# # Rename epimachine gene exp data
# baseline_vs_changes_gene_renamed <- baseline_vs_changes_gene %>%
#   rename_with(~ paste0(.x, "_gene"), ends_with("_baseline")) %>%
#   rename_with(~ paste0(.x, "_gene"), starts_with("delta_PC"))


# 3. Join metabolomic, lipidomic, and CpG PCA results
metab_cpg_lip_combined <- baseline_vs_changes_all_cpg_renamed %>%     # All SPP
  left_join(baseline_vs_changes_lip_renamed,            # All SPP
    by = c("colony", "baseline_tp", "next_tp", "interval")
  ) %>%
  left_join(
    baseline_vs_changes_metab_renamed,        
    by = c("colony", "baseline_tp", "next_tp", "interval")
  ) %>%
  # left_join(
  #   baseline_vs_changes_gene_renamed,
  #   by = c("colony", "baseline_tp", "next_tp", "interval")
  # ) %>%
  mutate(interval_label = paste0(baseline_tp, "–", next_tp),
         species = str_sub(colony, 1, 3))
```

# Analysis

## Metabolomic PC --> Expression of epigenetic machinery genes [ACR only]
```{r metabPC_exp}
# Combine epimachine gene exp with metab PC
epimachine_metab <- epimachine_long %>%
  inner_join(
    pca_results_metab %>% select(colony, timepoint, PC1),
    by = c("colony", "timepoint")
  )


gene_pc_results_all_tp <- epimachine_metab %>%
  group_by(gene_id) %>%
  summarise(
    n = sum(is.finite(logcount) & is.finite(PC1)),
    gene_sd = sd(logcount, na.rm = TRUE),
    pc_sd = sd(PC1, na.rm = TRUE),
    cor_test = list(
      if (!is.na(gene_sd) && !is.na(pc_sd) && gene_sd > 0 && pc_sd > 0) {
        cor.test(logcount, PC1)
      } else {
        NA
      }
    ),
    .groups = "drop"
  ) %>%
  mutate(
    estimate = map_dbl(cor_test, ~ if (is.list(.x)) .x$estimate else NA_real_),
    p_value = map_dbl(cor_test, ~ if (is.list(.x)) .x$p.value else NA_real_),
    p_adj = p.adjust(p_value, method = "fdr")) %>%
  select(gene_id, n, estimate, p_value, p_adj)

# Get top 10 most strongly correlated genes (by absolute correlation)
top12_genes <- gene_pc_results_all_tp %>%
  arrange(-abs(estimate)) %>%
  slice_head(n = 12) %>%
  pull(gene_id)

# Plot logcount vs. PC1 for top 10 genes
epimachine_metab %>%
  filter(gene_id %in% top12_genes) %>%
  ggplot(aes(x = PC1, y = logcount)) +
  geom_point(aes(color = timepoint), alpha = 0.7, size = 1.5) +
  geom_smooth(method = "lm", se = FALSE, color = "black", linetype = "dashed") +
  facet_wrap(~ gene_id, scales = "free_y") +
  labs(
    title = "Top 12 Genes Most Correlated with Metabolomic PC1",
    x = "Metabolomic PC1",
    y = "Log Gene Expression",
    color = "Timepoint"
  ) +
  theme_minimal(base_size = 11) +
  ggpubr::stat_cor()



```

## Metabolomic PC baseline --> Methylation PC change
```{r metabPC_methPCchange}
# METAB vs. CPG
metab_cpg_lip_combined %>%
  filter(!is.na(PC1_baseline_metab)) %>%
  ggplot(aes(x = PC1_baseline_metab, y = delta_PC1_cpg)) +
  geom_point(aes(color = species, shape = site.x), size = 3, alpha = 0.7) +
  facet_wrap(species ~ interval_label, scales = "free") +
  geom_smooth(method = "lm", color = "black") +
  ggpubr::stat_cor() +
  labs(
    x = "Baseline Metabolomic PC1",
    y = "Change in Methylation PC1",
    title = "Metabolomic baseline vs. epigenetic change across time intervals"
  ) +
  theme_minimal()
```

## Methylation PC baseline --> Metabolomic PC change
```{r methPC_metabPCchange}
metab_cpg_lip_combined %>%
  filter(!is.na(PC1_baseline_metab)) %>%
  ggplot(aes(x = PC1_baseline_cpg, y = delta_PC1_metab)) +
  geom_point(aes(color = species, shape = site.x), size = 3, alpha = 0.8) +
  geom_smooth(method = "lm", se = TRUE, color = "black") +
  ggpubr::stat_cor() +
  facet_wrap(species ~ interval_label, scales = "free") +
  labs(
    x = "Baseline Epigenetic PC1",
    y = "Change in Metabolomic PC1",
    title = "Baseline Epigenetic PC1 vs. Metabolomic PC1 Change by Interval"
  ) +
  theme_minimal()
```

## Lipidomic PC baseline --> Methylation PC change 
```{r lipPC_methPCchange}

# LIPIDS vs. CPG

metab_cpg_lip_combined %>%
  filter(!is.na(PC1_baseline_lip)) %>%
  ggplot(aes(x = PC1_baseline_lip, y = delta_PC1_cpg)) +
  geom_point(aes(color = species, shape = site.x), size = 3, alpha = 0.7) +
  facet_wrap(species ~ interval_label, scales = "free") +
  geom_smooth(method = "lm", color = "black") +
  ggpubr::stat_cor() +
  labs(
    x = "Baseline Lipidomic PC1",
    y = "Change in Epigenetic PC1",
    title = "Lipid baseline vs. epigenetic change across time intervals"
  ) +
  theme_minimal()
```

## Methylation PC baseline --> Lipidomic PC change
```{r methPC_lipPCchange}

metab_cpg_lip_combined %>%
  filter(!is.na(delta_PC1_lip)) %>%
  ggplot(aes(x = PC1_baseline_cpg, y = delta_PC1_lip)) +
  geom_point(aes(color = species, shape = site.x), size = 3, alpha = 0.8) +
  geom_smooth(method = "lm", se = TRUE, color = "black") +
  ggpubr::stat_cor() +
  facet_wrap(species ~ interval_label, scales = "free") +
  labs(
    x = "Baseline Epigenetic PC1",
    y = "Change in Lipidomic PC1",
    title = "Baseline Epigenetic PC1 vs. Lipid PC1 Change by Interval"
  ) +
  theme_minimal()
```


## Compute absolute and net change in Methylation
```{r methChange}
# Function to compute abs and net changes in methylation across all cpg sites from one time point to another.
# sd_filter == TRUE will Filter out CpG sites showing <1S.D. change in methylation (swamping noise)
compute_methylation_changes <- function(cpg_wide_df, cpg_cols = NULL, sd_filter = FALSE) {
  # If not specified, infer CpG columns as everything except colony and timepoint
  if (is.null(cpg_cols)) {
    cpg_cols <- setdiff(colnames(cpg_wide_df), c("colony", "timepoint"))
  }

  cpg_wide_df %>%
    mutate(time_num = as.numeric(stringr::str_extract(timepoint, "\\d+"))) %>%
    arrange(colony, time_num) %>%
    group_by(colony) %>%
    group_modify(~ {
      if (nrow(.x) < 2) return(tibble())

      mat <- as.matrix(.x[, cpg_cols])
      timepoints <- .x$timepoint
      n <- nrow(mat)

      idx_pairs <- which(upper.tri(matrix(NA, n, n)), arr.ind = TRUE)

      diffs <- mat[idx_pairs[,2], , drop = FALSE] - mat[idx_pairs[,1], , drop = FALSE]

      if (sd_filter) {
        # For each row (interval), filter out CpGs changing < 1 SD from mean
        diffs <- t(apply(diffs, 1, function(diff_row) {
          mean_diff <- mean(diff_row, na.rm = TRUE)
          sd_diff <- sd(diff_row, na.rm = TRUE)
          keep <- abs(diff_row - mean_diff) >= sd_diff
          diff_row[!keep] <- NA
          diff_row
        }))
      }

      tibble(
        baseline_tp = timepoints[idx_pairs[,1]],
        next_tp     = timepoints[idx_pairs[,2]],
        interval    = paste0(baseline_tp, "-", next_tp),
        total_abs_change = rowSums(abs(diffs), na.rm = TRUE),
        total_net_change = rowSums(diffs, na.rm = TRUE)
      )
    }) %>%
    ungroup() %>%
    select(colony, baseline_tp, next_tp, interval, total_abs_change, total_net_change)
}

# For Acropora (with filtering)
acr_methylation_change_summary <- compute_methylation_changes(acr_cpg_wide_by_colony_tp, sd_filter = TRUE)

# For Pocillopora (without filtering)
poc_methylation_change_summary <- compute_methylation_changes(poc_cpg_wide_by_colony_tp, sd_filter = TRUE)


# combine methylation change summary across species
all_methylation_change_summary <- bind_rows(
  acr_methylation_change_summary,
  poc_methylation_change_summary)
```

## Metabolomic PC --> Abs. Methylation change 
```{r}
# join to metabolomic data
metab_methylation_res <- all_methylation_change_summary %>% 
  left_join(baseline_vs_changes_metab_renamed,
             by = c("colony", "baseline_tp")) %>%
  filter(!is.na(PC1_baseline_metab))


ggplot(metab_methylation_res, aes(x = PC1_baseline_metab, 
                                  y = total_abs_change)) +
  geom_point(aes(color = species, shape = site)) +
  geom_smooth(method = "lm", color = "black") +
  facet_grid(species~interval.x, scales = "free") +
  ggpubr::stat_cor() +
    theme_minimal()
```

## Lipidomic PC --> Abs. Methylation change
```{r}
# join to lipidomic data
lipid_methylation_res <- all_methylation_change_summary %>% 
  left_join(baseline_vs_changes_lip_renamed,
            by = c("colony", "baseline_tp")) %>%
  left_join(colony_md) %>%
  filter(!is.na(PC1_baseline_lip))

ggplot(lipid_methylation_res, aes(x = PC1_baseline_lip, y = total_abs_change)) +
  geom_point(aes(color = species, shape = site)) +
  geom_smooth(method = "lm", color = "black") +
  facet_grid(species~interval.x, scales = "free") +
  ggpubr::stat_cor() +
    theme_minimal()

```

## Individual metabolites --> expression of epigenetic machinery genes
```{r, metab_expr}

metab_long <- metab_data_wide %>%
  pivot_longer(
    cols = -c(sample, colony, timepoint, species, site),
    names_to = "metabolite",
    values_to = "value"
  )

# Join metabolite and gene expression data
metab_gene_joined <- epimachine_long %>%
  select(gene_id, colony, timepoint, logcount) %>%
  inner_join(
    metab_long %>% select(colony, timepoint, metabolite, value),
    by = c("colony", "timepoint")
  )

# Correlation between gene expression and metabolite value
gene_metab_corrs <- metab_gene_joined %>%
  group_by(gene_id, metabolite) %>%
  summarise(
    n = sum(is.finite(logcount) & is.finite(value)),
    gene_sd = sd(logcount, na.rm = TRUE),
    metab_sd = sd(value, na.rm = TRUE),
    cor_test = list(
      if (!is.na(gene_sd) && !is.na(metab_sd) && gene_sd > 0 && metab_sd > 0) {
        cor.test(logcount, value)
      } else {
        NA
      }
    ),
    .groups = "drop"
  ) %>%
  mutate(
    estimate = map_dbl(cor_test, ~ if (is.list(.x)) .x$estimate else NA_real_),
    p_value = map_dbl(cor_test, ~ if (is.list(.x)) .x$p.value else NA_real_),
    p_adj = p.adjust(p_value, method = "fdr")
  ) %>%
  select(gene_id, metabolite, n, estimate, p_value, p_adj)



# Get top 10 strongest gene–metabolite correlations
top10_pairs <- gene_metab_corrs %>%
  arrange(-abs(estimate)) %>%
  slice_head(n = 12)

# Join back to the long data for plotting
plot_data <- epimachine_long %>%
  select(gene_id, colony, timepoint, logcount) %>%
  inner_join(
    metab_long %>% select(colony, timepoint, metabolite, value),
    by = c("colony", "timepoint")
  ) %>%
  inner_join(
    top10_pairs %>% select(gene_id, metabolite),
    by = c("gene_id", "metabolite")
  ) %>%
  mutate(label = paste(gene_id, "vs.", metabolite))

# Plot
ggplot(plot_data, aes(x = value, y = logcount, color = timepoint)) +
  geom_point(alpha = 0.7, size = 2.5) +
  geom_smooth(method = "lm", se = FALSE, color = "black", linetype = "dashed") +
  facet_wrap(~ label, scales = "free") +
  labs(
    title = "Top 10 Gene–Metabolite Correlations",
    x = "Metabolite Value",
    y = "Log Gene Expression",
    color = "Timepoint"
  ) +
  theme_minimal(base_size = 11)

```

## Individual metabolites --> Abs./Net Methylation changes
```{r}
# Reshape methylation changes to long format
methylation_change_long <- all_methylation_change_summary %>%
  pivot_longer(
    cols = c(total_net_change, total_abs_change),
    names_to = "change_type",
    values_to = "methylation_change"
  )

# Join metabolite baseline values to methylation change data
metab_methylation_joined <- methylation_change_long %>%
  inner_join(
    metab_long %>%
      rename(baseline_tp = timepoint, baseline_value = value),
    by = c("colony", "baseline_tp")
  )

# Correlation tests for each metabolite × species × interval × change type
metab_corrs <- metab_methylation_joined %>%
  group_by(species, metabolite, interval, change_type) %>%
  summarise(
    cor_test = list(tryCatch(cor.test(baseline_value, methylation_change), error = function(e) NA)),
    .groups = "drop"
  ) %>%
  mutate(
    tidied = map(cor_test, ~ if (is.list(.x)) broom::tidy(.x) else tibble(estimate = NA_real_, p.value = NA_real_))
  ) %>%
  unnest(tidied) %>%
  select(species, metabolite, interval, change_type, estimate, p.value) %>%
  mutate(
    sig = p.value < 0.05,
    strong = abs(estimate) > 0.5
  )

# Rank top metabolites by strongest abs or net correlation within a species
top_metabs <- metab_corrs %>%
  group_by(metabolite, species, change_type) %>%
  summarise(
    mean_r = mean(abs(estimate), na.rm = TRUE),
    .groups = "drop"
  ) %>%
  arrange(desc(mean_r)) %>%
  slice_head(n = 10) %>%
  pull(metabolite)

# Define plotting function to show both net + abs methylation changes
plot_metab_vs_methylation_change_dual <- function(metab_data_wide, methylation_change_long, variable_name) {
  # Prepare baseline values for this metabolite
  metab_var <- metab_data_wide %>%
    select(colony, timepoint, species, site, !!sym(variable_name)) %>%
    rename(baseline_value = !!sym(variable_name))

  # Join baseline value to methylation data
  joined <- methylation_change_long %>%
    left_join(metab_var %>% rename(baseline_tp = timepoint), by = c("colony", "baseline_tp")) %>%
    mutate(metabolite = variable_name) %>%  # manually tag metabolite
    filter(!is.na(baseline_value))

  ggplot(joined, aes(x = baseline_value, y = methylation_change, color = change_type)) +
    geom_point(aes(shape = site), size = 3, alpha = 0.7) +
    geom_smooth(method = "lm", se = TRUE, linetype = "dashed") +
    facet_wrap(species ~ interval, scales = "free", nrow = 2) +
    labs(
      x = paste("Baseline", variable_name),
      y = "Methylation Change",
      title = paste("Baseline", variable_name, "vs. Methylation Change (Abs + Net)")
    ) +
    theme_minimal() +
    scale_color_manual(
      values = c("total_abs_change" = "darkorange", "total_net_change" = "steelblue"),
      labels = c("Absolute", "Net"),
      name = "Change Type"
    ) +
  # Add abs change correlation at the top
  ggpubr::stat_cor(
    data = ~ subset(.x, change_type == "total_abs_change"),
    method = "pearson",
    label.x.npc = "left", label.y.npc = 1
  ) +
  # Add net change correlation at the bottom
  ggpubr::stat_cor(
    data = ~ subset(.x, change_type == "total_net_change"),
    method = "pearson",
    label.x.npc = "left", label.y.npc = 0
  )
}



# Loop to generate plots for top 10 metabolites
for (metab in top_metabs) {
  p <- plot_metab_vs_methylation_change_dual(
    metab_data_wide = metab_data_wide,
    methylation_change_long = methylation_change_long,
    variable_name = metab
  )
  print(p)
}

```





## Individual lipids --> methylation changes?

```{r, fig.width = 10}
# Full lipid correlation analysis and plotting
# 1. Reshape lipid data to long format
lip_long <- lip_data_wide %>%
  left_join(colony_md) %>%
  pivot_longer(
    cols = -c(sample, colony, timepoint, species, site, type),
    names_to = "lipid",
    values_to = "value"
  )

# 2. Join baseline lipid value to methylation interval data
lip_methylation_joined <- all_methylation_change_summary %>%
  inner_join(
    lip_long %>%
      rename(baseline_tp = timepoint, baseline_value = value),
    by = c("colony", "baseline_tp")
  )

# 3. Compute correlation for each lipid × interval
lip_corrs <- lip_methylation_joined %>%
  group_by(species, lipid, interval) %>%
  summarise(
    cor_test = list(cor.test(baseline_value, total_abs_change)),
    .groups = "drop"
  ) %>%
  mutate(tidied = map(cor_test, broom::tidy)) %>%
  unnest(tidied) %>%
  select(species, lipid, interval, estimate, p.value) %>%
  mutate(
    sig = p.value < 0.05,
    strong = abs(estimate) > 0.5
  )

# 4. Summarize lipids by frequency of strong/significant correlations
lip_summary <- lip_corrs %>%
  group_by(lipid) %>%
  summarise(
    n_intervals = n(),
    n_strong_sig = sum(sig & strong),
    avg_cor = mean(abs(estimate)),
    .groups = "drop"
  ) %>%
  arrange(desc(n_strong_sig), desc(avg_cor))

# 5. Define plot function for individual lipids
plot_lipid_vs_methylation_change <- function(lip_data_wide, methylation_change_summary, variable_name) {
  lip_var <- lip_data_wide %>%
    select(colony, timepoint, species, !!sym(variable_name))
  
  joined <- methylation_change_summary %>%
    inner_join(
      lip_var %>%
        rename(baseline_tp = timepoint, baseline_value = !!sym(variable_name)),
      by = c("colony", "baseline_tp")
    ) %>%
    left_join(colony_md)
  
  ggplot(joined, aes(x = baseline_value, y = total_abs_change)) +
    geom_point(aes(color = species, shape = site), size = 3, alpha = 0.7) +
    geom_smooth(method = "lm", se = TRUE, color = "black") +
    facet_wrap(species ~ interval, scales = "free", nrow = 2) +
    labs(
      x = paste("Baseline", variable_name),
      y = "Abs Change in Methylation",
      title = paste("Baseline", variable_name, "vs. Methylation Change")
    ) +
    ggpubr::stat_cor(method = "pearson", label.x.npc = "left", label.y.npc = "top") +
    theme_minimal()
}

# 6. Plot top 10 lipids
for (i in 1:10) {
  p <- plot_lipid_vs_methylation_change(
    lip_data_wide = lip_data_wide,
    methylation_change_summary = all_methylation_change_summary,
    variable_name = lip_summary$lipid[i]
  )
  print(p)
}

```

## Lipid classes --> Abs. methylation change
```{r}
# Summarize lipid class composition at baseline timepoints
lipid_class_baseline <- lipid_comp %>%
  select(colony, timepoint, class, percent_class) %>%
  distinct()  # removes duplicate lipids within a class

lipid_class_long <- lipid_class_baseline %>%
  rename(variable = class, value = percent_class)

# Calculate FA:TG ratio
lipid_ratios <- lipid_comp %>%
  distinct(sample, species, colony, timepoint, class, total_class_concentration) %>%
  pivot_wider(
    names_from = class,
    values_from = total_class_concentration
  ) %>%
  mutate(
    FA_TG_ratio = FA / TG
  )

lipid_ratio_long <- lipid_ratios %>%
  select(colony, timepoint, FA_TG_ratio) %>%
  mutate(variable = "FA_TG_ratio", value = FA_TG_ratio) %>%
  select(colony, timepoint, variable, value)

lipid_metrics_long <- bind_rows(lipid_class_long, lipid_ratio_long)

# Join with methylation change data by colony and baseline timepoint
lipid_methylation_long <- all_methylation_change_summary %>%
  inner_join(
    lipid_metrics_long,
    by = c("colony", "baseline_tp" = "timepoint")
  ) %>%
  left_join(colony_md)

# Correlation per lipid class
# Summarize lipid class correlations with methylation change
lipid_corrs <- lipid_methylation_long %>%
  group_by(species, variable, interval) %>%
  summarise(
    n = n(),
    cor_test = list(
      tryCatch(cor.test(value, total_abs_change), error = function(e) NA)
    ),
    .groups = "drop"
  ) %>%
  mutate(
    estimate = map_dbl(cor_test, ~ if (is.list(.x)) .x$estimate else NA_real_),
    p_value  = map_dbl(cor_test, ~ if (is.list(.x)) .x$p.value  else NA_real_),
    p_adj    = p.adjust(p_value, method = "fdr")
  )




plot_lipid_metric_vs_methylation_change <- function(variable_name) {
  plot_data <- lipid_methylation_long %>%
    filter(variable == variable_name) %>%
    left_join(colony_md, by = c("colony", "species", "site"))

  ggplot(plot_data, aes(x = value, y = total_abs_change)) +
    geom_point(aes(color = species, shape = site), size = 3, alpha = 0.7) +
    geom_smooth(method = "lm", se = TRUE, color = "black") +
    facet_wrap(species ~ interval, scales = "free", nrow = 2) +
    labs(
      x = paste("Baseline", variable_name),
      y = "Abs. Change in Methylation",
      title = paste("Baseline", variable_name, "vs. Methylation Change")
    ) +
    ggpubr::stat_cor(method = "pearson", label.x.npc = "left", label.y.npc = "top") +
    theme_minimal()
}




# Rank variables (lipid classes + FA:TG ratio) by strongest absolute correlation
lipid_variable_ranked <- lipid_corrs %>%
  group_by(variable) %>%
  summarise(
    strongest_abs_r = max(abs(estimate), na.rm = TRUE),
    .groups = "drop"
  ) %>%
  arrange(desc(strongest_abs_r)) %>%
  pull(variable)


for (var in lipid_variable_ranked) {
  p <- plot_lipid_metric_vs_methylation_change(variable_name = var)
  print(p)
}

```



