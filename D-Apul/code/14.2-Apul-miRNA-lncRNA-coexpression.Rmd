---
title: "14.2-Apul-miRNA-lncRNA-coexpression"
author: "Kathleen Durkin"
date: "2025-04-15"
always_allow_html: true
output: 
  github_document:
    toc: true
    toc_depth: 3
    number_sections: true
    html_preview: true 
  bookdown::html_document2:
    theme: cosmo
    toc: true
    toc_float: true
    number_sections: true
    code_folding: show
    code_download: true
---

```{r}
library(energy)
library(tidyr)
library(dplyr)
library(readr)
library(ggplot2)
```

Now that we've found putative interactions, including those with high complementarity, in `10-Apul-lncRNA-miRNA-miRanda` we need to validate by examining patterns of coexpression. We'd expect a putatively-interacting miRNA-lncRNA pair to be highly coexpressed, and we'd expect a strong negative relationship to indicate either a lncRNA sponging miRNA OR an miRNA targeting lncRNA for degradation.

## Obtain Pearson's coefficient correlation values

Read in, format, and normalize data

```{r}
miRNA_counts <- read.delim("../output/03.10-D-Apul-sRNAseq-expression-DESeq2/Apul_miRNA_ShortStack_counts_formatted.txt")
# Simplify column names
colnames(miRNA_counts) <- sub("_.*", "", colnames(miRNA_counts))
colnames(miRNA_counts) <- sub("X", "", colnames(miRNA_counts))

# Remove any miRNA with 0 counts across samples 
miRNA_counts<-miRNA_counts %>%
    mutate(Total = rowSums(.[, 1:5]))%>%
    filter(!Total==0)%>%
    dplyr::select(!Total)

lncRNA_counts_full <- read.delim("../output/08-Apul-lncRNA/counts.txt", skip=1) 
rownames(lncRNA_counts_full) <- lncRNA_counts_full$Geneid
lncRNA_counts <- lncRNA_counts_full %>% select(-Geneid, -Chr, -Start, -End, -Strand, -Length)

# Format lncRNA column names to match the miRNA names
colnames(lncRNA_counts) <- sub("...data.", "", colnames(lncRNA_counts))
colnames(lncRNA_counts) <- sub(".sorted.bam", "", colnames(lncRNA_counts))
# Order lncRNA column names to match the miRNA column order
lncRNA_counts <- lncRNA_counts[, colnames(miRNA_counts)]

# Check that the columns match name and order for both dataframes
colnames(lncRNA_counts) == colnames(miRNA_counts)

# Remove any lncRNAs with 0 for all samples 
lncRNA_counts <- lncRNA_counts %>%
    mutate(Total = rowSums(.[, 1:5]))%>%
    filter(!Total==0)%>%
    dplyr::select(!Total)

# Function to normalize counts (simple RPM normalization)
normalize_counts <- function(counts) {
  rpm <- t(t(counts) / colSums(counts)) * 1e6
  return(rpm)
}

miRNA_norm <- normalize_counts(miRNA_counts)
lncRNA_norm <- normalize_counts(lncRNA_counts)

```

```{r, eval=FALSE}

# Function to calculate PCC and p-value for a pair of vectors
calc_pcc <- function(x, y) {
  result <- cor.test(x, y, method = "pearson")
  return(c(PCC = result$estimate, p_value = result$p.value))
}

# Create a data frame of all miRNA-lncRNA pairs
pairs <- expand.grid(miRNA = rownames(miRNA_norm), lncRNA = rownames(lncRNA_norm))

# Calculate PCC and p-value for each pair
pcc_results <- pairs %>%
  rowwise() %>%
  mutate(
    pcc_stats = list(calc_pcc(miRNA_norm[miRNA,], lncRNA_norm[lncRNA,]))
  ) %>%
  unnest_wider(pcc_stats)

# Adjust p-values for FDR
pcc_results <- pcc_results %>%
  mutate(adjusted_p_value = p.adjust(p_value, method = "fdr"))

# Save as csv
write.csv(pcc_results, "../output/14.2-Apul-miRNA-lncRNA-coexpression/Apul-PCC_miRNA_lncRNA-full.csv")
```

Check

```{r}
# Read in results 
pcc_results <- read.csv("../output/14.2-Apul-miRNA-lncRNA-coexpression/Apul-PCC_miRNA_lncRNA-full.csv")

# Use this code to download the PCC results if needed 
#pcc_results <- read.csv("https://gannet.fish.washington.edu/kdurkin1/ravenbackups/timeseries_molecular/D-Apul/output/14.2-Apul-miRNA-lncRNA-coexpression/Apul-PCC_miRNA_lncRNA-full.csv")

nrow(pcc_results)
nrow(pcc_results%>% filter(abs(PCC.cor) > 0.90))
nrow(pcc_results %>% filter(p_value < 0.05))
nrow(pcc_results %>% filter(p_value < 0.05 & abs(PCC.cor) > 0.90))
```

of the 950,283 possible miRNA-lncRNA interactions, 3 have a Pearson's correlation coefficient with a magnitude above 0.9, and 81,605 have a significant correlation (pval\<0.05). All of the coefficients with a magnitude \>0.9 are significant.

I find it interesting that so many putative interactions have significant pvalues, but so few have correlation coefficients above 0.9. What does the distribution of significant correlation coefficients look like?

```{r}
ggplot(pcc_results[pcc_results$p_value < 0.05,], aes(x = PCC.cor)) +
  geom_density(fill = "blue", alpha = 0.5) +
  labs(title = "Density of Significant Correlations",
       x = "Correlation Coefficient",
       y = "Density") +
  theme_minimal()

ggplot(pcc_results[pcc_results$p_value < 0.05,], aes(x = abs(PCC.cor))) +
  geom_density(fill = "blue", alpha = 0.5) +
  labs(title = "Density of Significant Correlations (magnitudes)",
       x = "Magnitude of Correlation Coefficient",
       y = "Density") +
  theme_minimal()
```

Mean of the absolute value of correlation for significant correlation coefficients is `{r} round(mean(abs(pcc_results[pcc_results$p_value < 0.05,]$PCC.cor)),2)`

# Incorporate miRanda target prediction results

## full lncRNA

```{r}
# miRNA-lncRNA_full miRanda output
miRNA_lncRNA_miRanda <- read_delim("../output/10-Apul-lncRNA-miRNA-miRanda/Apul-miRanda-lncRNA-strict-parsed.txt", col_names=FALSE)
colnames(miRNA_lncRNA_miRanda) <- c("mirna", "Target", "Score", "Energy_Kcal_Mol", "Query_Aln", "Subject_Aln", "Al_Len", "Subject_Identity", "Query_Identity")

# format miRNA and lncRNA names
geneIDs <- read_delim("../output/05-Apul-annotate-UTRs/Apul-lncRNA-FUNids.txt", col_names=FALSE)
geneIDs$X4 <- gsub("Parent=", "", geneIDs$X4)

miRNA_lncRNA_miRanda$mirna <- gsub(">", "", miRNA_lncRNA_miRanda$mirna)
miRNA_lncRNA_miRanda$mirna <- gsub("\\..*", "", miRNA_lncRNA_miRanda$mirna)

miRNA_lncRNA_miRanda <- left_join(miRNA_lncRNA_miRanda, geneIDs, by=c("Target" = "X1"))
miRNA_lncRNA_miRanda <- select(miRNA_lncRNA_miRanda, -X2,-X3,-X5)

# Finally, create a column that conatins both the miRNA and interacting lncRNA
pcc_results$interaction <- paste(pcc_results$miRNA, "_", pcc_results$lncRNA)
miRNA_lncRNA_miRanda$interaction <- paste(miRNA_lncRNA_miRanda$mirna, "_", miRNA_lncRNA_miRanda$X4)

# Annotate w PCC info 
miRNA_lncRNA_miRanda <- left_join(miRNA_lncRNA_miRanda, pcc_results, by="interaction")
```

```{r}
# Filter to high complementarity putative targets
target_21bp <- miRNA_lncRNA_miRanda[miRNA_lncRNA_miRanda$Al_Len > 20,]
target_21bp_3mis <- target_21bp[target_21bp$Subject_Identity>85,]

# How many w significant correlation?
nrow(miRNA_lncRNA_miRanda)
nrow(miRNA_lncRNA_miRanda %>% filter(p_value < 0.05))
nrow(target_21bp %>% filter(p_value < 0.05))
nrow(target_21bp_3mis %>% filter(p_value < 0.05))
```

For miRNA binding to the lncRNA CDS, miRanda predicts 814,426 putative interactions. Of these, 99,958 have significant PCCs; 17,425 are \>21bp and have signficant PCCs; and 26 are \>21bp with \<=3 mismatches and have significant PCCs.

## 3'UTR

```{r}
# Read in data

# miRNA-lncRNA_full miRanda output
miRNA_3UTR_miRanda <- read_delim("../output/07-Apul-miRNA-lncRNA-miRanda/Apul-miRanda-3UTR-strict-parsed.txt", col_names=FALSE)
colnames(miRNA_3UTR_miRanda) <- c("mirna", "Target", "Score", "Energy_Kcal_Mol", "Query_Aln", "Subject_Aln", "Al_Len", "Subject_Identity", "Query_Identity")

# format miRNA and lncRNA names
geneIDs <- read_delim("../output/05-Apul-annotate-UTRs/Apul-3UTR-FUNids.txt", col_names=FALSE)
geneIDs$X4 <- gsub("Parent=", "", geneIDs$X4)

miRNA_3UTR_miRanda$mirna <- gsub(">", "", miRNA_3UTR_miRanda$mirna)
miRNA_3UTR_miRanda$mirna <- gsub("\\..*", "", miRNA_3UTR_miRanda$mirna)
#miRNA_3UTR_miRanda$Target <- gsub("::.*", "", miRNA_3UTR_miRanda$Target)

miRNA_3UTR_miRanda <- left_join(miRNA_3UTR_miRanda, geneIDs, by=c("Target" = "X1"))
miRNA_3UTR_miRanda <- select(miRNA_3UTR_miRanda, -X2,-X3,-X5)

# Somehow ended up with a many-to-many relationship, so remove duplicate rows
miRNA_3UTR_miRanda <- miRNA_3UTR_miRanda[!duplicated(miRNA_3UTR_miRanda), ]

# Finally, create a column that conatins both the miRNA and interacting lncRNA
miRNA_3UTR_miRanda$interaction <- paste(miRNA_3UTR_miRanda$mirna, "_", miRNA_3UTR_miRanda$X4)

# Annotate w PCC info 
miRNA_3UTR_miRanda <- left_join(miRNA_3UTR_miRanda, pcc_results, by="interaction")

```

```{r}
# Filter to high complementarity putative targets
target_3UTR_21bp <- miRNA_3UTR_miRanda[miRNA_3UTR_miRanda$Al_Len > 20,]
target_3UTR_21bp_3mis <- target_3UTR_21bp[target_3UTR_21bp$Subject_Identity>85,]

# How many w significant correlation?
nrow(miRNA_3UTR_miRanda)
nrow(miRNA_3UTR_miRanda %>% filter(p_value < 0.05))
nrow(target_3UTR_21bp %>% filter(p_value < 0.05))
nrow(target_3UTR_21bp_3mis %>% filter(p_value < 0.05))
```

For miRNA binding to the 3'UTR, miRanda predicts 123,123 putative interactions. Of these, 11,693 have significant PCCs; 2,142 are \>21bp and have signficant PCCs; and 3 are \>21bp with \<=3 mismatches and have a significant PCC.

## 5'UTR

```{r}
# miRNA-5'UTR miRanda output
miRNA_5UTR_miRanda <- read_delim("../output/07.1-Apul-miRNA-lncRNA-miRanda-additional_inputs/Apul-miRanda-5UTR_1kb-strict-parsed.txt", col_names=FALSE)
colnames(miRNA_5UTR_miRanda) <- c("mirna", "Target", "Score", "Energy_Kcal_Mol", "Query_Aln", "Subject_Aln", "Al_Len", "Subject_Identity", "Query_Identity")

# format miRNA and lncRNA names
geneIDs <- read_delim("../output/05-Apul-annotate-UTRs/Apul-5UTR-FUNids.txt", col_names=FALSE)
geneIDs$X4 <- gsub("Parent=", "", geneIDs$X4)

miRNA_5UTR_miRanda$mirna <- gsub(">", "", miRNA_5UTR_miRanda$mirna)
miRNA_5UTR_miRanda$mirna <- gsub("\\..*", "", miRNA_5UTR_miRanda$mirna)

miRNA_5UTR_miRanda <- left_join(miRNA_5UTR_miRanda, geneIDs, by=c("Target" = "X1"))
miRNA_5UTR_miRanda <- select(miRNA_5UTR_miRanda, -X2,-X3,-X5)

# Somehow ended up with a many-to-many relationship, so remove duplicate rows
miRNA_5UTR_miRanda <- miRNA_5UTR_miRanda[!duplicated(miRNA_5UTR_miRanda), ]

# Finally, create a column that contains both the miRNA and interacting lncRNA
pcc_results$interaction <- paste(pcc_results$miRNA, "_", pcc_results$lncRNA)
miRNA_5UTR_miRanda$interaction <- paste(miRNA_5UTR_miRanda$mirna, "_", miRNA_5UTR_miRanda$X4)

# Annotate w PCC info 
miRNA_5UTR_miRanda <- left_join(miRNA_5UTR_miRanda, pcc_results, by="interaction")
```

```{r}
# Filter to high complementarity putative targets
target_5UTR_21bp <- miRNA_5UTR_miRanda[miRNA_5UTR_miRanda$Al_Len > 20,]
target_5UTR_21bp_3mis <- target_5UTR_21bp[target_5UTR_21bp$Subject_Identity>85,]

# How many w significant correlation?
nrow(miRNA_5UTR_miRanda)
nrow(miRNA_5UTR_miRanda %>% filter(p_value < 0.05))
nrow(target_5UTR_21bp %>% filter(p_value < 0.05))
nrow(target_5UTR_21bp_3mis %>% filter(p_value < 0.05))
```

For miRNA binding to the 5'UTR, miRanda predicts 115,265 putative interactions. Of these, 10,623 have significant PCCs; 1,775 are \>21bp and have signficant PCCs; and 3 are \>21bp with \<=3 mismatches and have significant PCCs.

# Summary

How does different input and/or complementarity filtering affect \# putative interactions:

Reminder summary of miRanda results:

| Input     | unfiltered | filtered for complementarity | \% retained |
|-----------|------------|------------------------------|-------------|
| full lncRNA | 814426     | 181                          | 0.0222 %    |
| 5'UTR     | 115265     | 20                           | 0.0174 %    |
| 3'UTR     | 123123     | 33                           | 0.0268 %    |

For different filters, how many putative interactions ***also show significant coexpression*** (PCC pval \< 0.05)?

| Input     | All   | 21bp  | 21bp, \>=3 mismatch |
|-----------|-------|-------|---------------------|
| full lncRNA | 99958 | 17425 | 26                  |
| 5'UTR     | 10623 | 1775  | 3                   |
| 3'UTR     | 11693 | 2142  | 3                   |

Note that some putative interactions indicated by miRanda are not present in the counts data (i.e. the miRNA and/or lncRNA had 0 counts inour RNAseq data), and are thus excluded from the PCC-filtered data

Is there a clear "cutoff" for what complementarity parameters are mostassociated with significant coexpression?

```{r}

miRNA_lncRNA_miRanda <- miRNA_lncRNA_miRanda %>% mutate(Source = "lncRNA")
miRNA_3UTR_miRanda <- miRNA_3UTR_miRanda %>% mutate(Source = "3UTR")
miRNA_5UTR_miRanda <- miRNA_5UTR_miRanda %>% mutate(Source = "5UTR")

# Combine
combined_df <- bind_rows(miRNA_lncRNA_miRanda, miRNA_3UTR_miRanda, miRNA_5UTR_miRanda)

# Convert Source to a factor for discrete shapes
combined_df$Source <- factor(combined_df$Source)

# Convert p-value condition into a categorical variable for coloring
combined_df$Significance <- ifelse(combined_df$p_value < 0.05, "p < 0.05", "p ≥ 0.05")
significant_df <- combined_df %>% filter(p_value < 0.05)

# Plot with jitter (significant coexpression only)
ggplot(significant_df, aes(x = Al_Len, 
                           y = as.numeric(gsub("%", "", Subject_Identity)), 
                           color = Source)) +
  geom_jitter(size = 1.5, width = 1, height = 1, alpha = 0.1) +
  scale_color_manual(values = c("lncRNA" = "red", "3UTR" = "blue", "5UTR" = "green")) +
  facet_wrap(~ Source) +
  labs(x = "Alignment Length (Al_Len)", 
       y = "Subject Identity (%)", 
       color = "Dataset", 
       title = "Significant (p < 0.05) Alignment Length vs. Subject Identity") +
  theme_minimal()
```

Interesting... there are signifcant coexpressions happening across both metrics of complementarity.

```{r}
# Save putative interactions with significantly correlated coexpression for visualization
# (e.g. creating an interaction network plot in Cytoscape)
write.csv(combined_df[combined_df$p_value < 0.05,], "../output/14.2-Apul-miRNA-lncRNA-coexpression/miRanda-PCC-significant-lncRNA_3UTR_5UTR.csv", row.names = FALSE)

```
